<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Study cases: Microservice apps (Springboot Rest API) - DevOps with Dimas Maryanto</title>
<meta name="description" content="Hai semuanya, di materi study cases untuk Pod and Container specification kali ini adalah lanjutan dari sebelumnya yang lebih advanced lagi yaitu Create and build microservices dengan framework Springboot Rest API dengan architecture seperti berikut:    Okay nah terlihat sedikit berbeda dengan application monolith sebelumnya, disini setiap service akan saling berkomunikasi dengan menggunakan protocol yang lightweight (ringan) seperti Rest API, grpc, messaging bus, database shared dan lain-lain. Pada study kasus kali ini terlihat pada diagram tersebut masih menggunakan physical / virtual-machine deployement kita akan migrasikan menggunakan orchestration container system dengan Kubernetes. Adapun tahap-tahap yang perlu kita lakukan yaitu     Develop aplikasi   How code works (Code Review)   The new architecture for orchestration container system   Containerize apps   Deploy to Kubernetes            Running as a Pod with namespace       Connecting other service from the another namespace       Specify container probes (health check)       Specify resource request and limit           Implement API Gateway using nginx reverse proxy   Ok tanpa berlama-lama yuk langsung aja kita bahas materi yang pertama:">


  <meta name="author" content="Dimas Maryanto">
  
  <meta property="article:author" content="Dimas Maryanto">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="DevOps with Dimas Maryanto">
<meta property="og:title" content="Study cases: Microservice apps (Springboot Rest API)">
<meta property="og:url" content="/posts/devops/orchestration/kubernetes/pods/04b-study-cases-microservice-backend-apps">


  <meta property="og:description" content="Hai semuanya, di materi study cases untuk Pod and Container specification kali ini adalah lanjutan dari sebelumnya yang lebih advanced lagi yaitu Create and build microservices dengan framework Springboot Rest API dengan architecture seperti berikut:    Okay nah terlihat sedikit berbeda dengan application monolith sebelumnya, disini setiap service akan saling berkomunikasi dengan menggunakan protocol yang lightweight (ringan) seperti Rest API, grpc, messaging bus, database shared dan lain-lain. Pada study kasus kali ini terlihat pada diagram tersebut masih menggunakan physical / virtual-machine deployement kita akan migrasikan menggunakan orchestration container system dengan Kubernetes. Adapun tahap-tahap yang perlu kita lakukan yaitu     Develop aplikasi   How code works (Code Review)   The new architecture for orchestration container system   Containerize apps   Deploy to Kubernetes            Running as a Pod with namespace       Connecting other service from the another namespace       Specify container probes (health check)       Specify resource request and limit           Implement API Gateway using nginx reverse proxy   Ok tanpa berlama-lama yuk langsung aja kita bahas materi yang pertama:">







  <meta property="article:published_time" content="2023-02-26T16:19:54+07:00">





  

  


<link rel="canonical" href="/posts/devops/orchestration/kubernetes/pods/04b-study-cases-microservice-backend-apps">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Dimas maryanto",
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="DevOps with Dimas Maryanto Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



<script src="/assets/js/jquery/jquery-3.6.4.min.js"></script>
    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
<link rel="manifest" href="/assets/favicon/site.webmanifest">
<link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.png" alt="DevOps with Dimas Maryanto"></a>
        
        <a class="site-title" href="/">
          DevOps with Dimas Maryanto
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/pages/recent-posts/">Archives</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/cources/">Cources</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/roadmaps/">Roadmaps</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/private-class/">Private class</a>
            </li><li class="masthead__menu-item">
              <a href="/pages/discount/">Promo</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <img src="/assets/images/profile.jpeg" alt="Dimas Maryanto" itemprop="image" class="u-photo">
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      Dimas Maryanto
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>I am an <strong>Instructure</strong> at Udemy and 
<strong>Chief Technology Officer</strong> at PT. Tabeldata Informatika</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  <hr>
  

  

  

  
    
    
  
  
  
  <nav class="toc">
    <header>
      <h4 class="nav__title">
        <i class="fas fa-file-alt"></i> 
        On this page
      </h4>
    </header>
    <ul class="toc__menu"><li><a href="#development-aplikasi">Development aplikasi</a></li><li><a href="#how-code-works-code-review">How code works (Code Review)</a></li><li><a href="#the-new-architecture">The new architecture</a></li><li><a href="#containerize-apps">Containerize apps</a></li><li><a href="#create-kubernetes-cluster-on-local">Create kubernetes cluster on local</a></li><li><a href="#deploy-to-kubernetes-cluster">Deploy to Kubernetes cluster</a></li><li><a href="#connecting-other-service-from-the-another-namespace">Connecting other service from the another namespace</a></li><li><a href="#specify-container-probes">Specify container probes</a></li><li><a href="#specify-resource-request-and-limit">Specify resource request and limit</a></li><li><a href="#implement-api-gateway-using-nginx-reverse-proxy">Implement API Gateway using nginx reverse proxy</a></li></ul>

  </nav>
  
  </div>




  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Study cases: Microservice apps (Springboot Rest API)">
    <meta itemprop="description" content="Hai semuanya, di materi study cases untuk Pod and Container specification kali ini adalah lanjutan dari sebelumnya yang lebih advanced lagi yaitu Create and build microservices dengan framework Springboot Rest API dengan architecture seperti berikut:Okay nah terlihat sedikit berbeda dengan application monolith sebelumnya, disini setiap service akan saling berkomunikasi dengan menggunakan protocol yang lightweight (ringan) seperti Rest API, grpc, messaging bus, database shared dan lain-lain. Pada study kasus kali ini terlihat pada diagram tersebut masih menggunakan physical / virtual-machine deployement kita akan migrasikan menggunakan orchestration container system dengan Kubernetes. Adapun tahap-tahap yang perlu kita lakukan yaitu  Develop aplikasi  How code works (Code Review)  The new architecture for orchestration container system  Containerize apps  Deploy to Kubernetes          Running as a Pod with namespace      Connecting other service from the another namespace      Specify container probes (health check)      Specify resource request and limit        Implement API Gateway using nginx reverse proxyOk tanpa berlama-lama yuk langsung aja kita bahas materi yang pertama:">
    <meta itemprop="datePublished" content="2023-02-26T16:19:54+07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="/posts/devops/orchestration/kubernetes/pods/04b-study-cases-microservice-backend-apps" class="u-url" itemprop="url">Study cases: Microservice apps (Springboot Rest API)
</a>
          </h1>
          
<p class="page__meta">

  
  
    <a href="/pages/cources/kubernetes" target="_blank" rel="noopener noreferrer">
      <i class="fas fa-link"></i>
      Kubernetes for DevOps
    </a>
    <span class="page__meta-sep"></span>
  



  
    
    <span class="page__meta-date">
      <i class="far fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2023-02-26T16:19:54+07:00">February 26, 2023</time>
    </span>
  

  <span class="page__meta-sep"></span>

  
    
    

    <span class="page__meta-readtime">
      <i class="far fa-clock" aria-hidden="true"></i>
      
        44 minute read
      
    </span>
  
    

</p>

        </header>
      

      <section class="page__content e-content" itemprop="text">
        
        <div class="text-right">
          <label class="switch">
            <input name="cource-content" onchange="showCourceContent(this.checked)" type="checkbox">
            <span class="slider"></span>
          </label>
        </div>        
        <aside id="cource_contents" style="display: none;" class="sidebar__right">
          
            
            
            
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Pengenalan Kubernetes">
        <label class="acordion-item-label" for="content-Pengenalan Kubernetes">
            Pengenalan Kubernetes
        </label>
        <div class="acordion-item-content">
            <ul>
            
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01-silabus">
                        
                        Silabus - DevOps Kubernetes...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01a-what-is-kubernetes">
                        
                        What is Kubernetes (k8s) ?
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01b-k8s-components">
                        
                        Kubernetes Components
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01c-k8s-api">
                        
                        The Kubernetes API
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01d-k8s-objects">
                        
                        What is Kubernetes Objects?
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01e-k8s-object-management">
                        
                        Managing Kubernetes Object
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01f-k8s-object-names-and-uids">
                        
                        Kubernetes Object Names and...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01g-k8s-namespaces">
                        
                        What is Kubernetes Namespaces?
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/01h-kubernetes-environtments">
                        
                        Kubernetes cluster environt...
                    </a>
                </li>
                
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Getting started with minikube">
        <label class="acordion-item-label" for="content-Getting started with minikube">
            Getting started with minikube
        </label>
        <div class="acordion-item-content">
            <ul>
            
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02-overview-learn-env">
                        
                        Overview learning environme...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02a-install-tools-for-macos">
                        
                        Install minikube on Mac (In...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02a-install-for-mac-apple-silicon">
                        
                        Install minikube on Mac (Ap...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02a-install-tools-for-windows">
                        
                        Install minikube for Window...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02a-install-tools-for-linux">
                        
                        Install minikube for Linux ...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02b-deploy-application">
                        
                        Deploying an apps/services ...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02c-minikube-basic-control">
                        
                        Minikube basic control
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02d-minikube-use-your-own-images">
                        
                        Using your own image into M...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02f-minikube-addons">
                        
                        Minikube addons features
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02g-minikube-access-apps">
                        
                        Access your apps/service in...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/02h-minikube-mount">
                        
                        Mounting filesystems to min...
                    </a>
                </li>
                
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Pods and Containers">
        <label class="acordion-item-label" for="content-Pods and Containers">
            Pods and Containers
        </label>
        <div class="acordion-item-content">
            <ul>
            
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03-overview-pod-containers">
                        
                        Overview Pod and Container ...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03a-workload-pods">
                        
                        Kubernetes Workloads with Pods
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03b-working-with-pods">
                        
                        Working with Pods
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03c-basic-pod-and-containers-config">
                        
                        Basic Pods and Containers C...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03d-pod-lifecycle">
                        
                        Pod & Container Lifecycle
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03e-init-containers">
                        
                        Initialization of Containers
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03f-pod-env-config">
                        
                        Configure env (Environment ...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03g-pod-resource-request-and-limit">
                        
                        Configure Request and Limit...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03h-pod-container-probe-config">
                        
                        Configure liveness, readine...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/03i-distruptions">
                        
                        Pod Disruptions
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/04-overview-study-cases">
                        
                        Overview Study Cases: Pod a...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/04a-study-cases-monolith-apps">
                        
                        Study Cases: Monolith apps ...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/pods/04b-study-cases-microservice-backend-apps">
                        
                        <i class="fas fa-bookmark"></i>
                        
                        Study cases: Microservice a...
                    </a>
                </li>
                
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Workload resources">
        <label class="acordion-item-label" for="content-Workload resources">
            Workload resources
        </label>
        <div class="acordion-item-content">
            <ul>
            
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/workloads/05-overview-workload-resources">
                        
                        Overview Kubernetes Workloa...
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/workloads/05a-what-is-workload">
                        
                        What is Workload Resources?
                    </a>
                </li>
                
                <li>
                    <a href="/posts/devops/orchestration/kubernetes/workloads/05b-deployment">
                        
                        Working with Deployment object
                    </a>
                </li>
                
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Networking (service)">
        <label class="acordion-item-label" for="content-Networking (service)">
            Networking (service)
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Store data using Volumes">
        <label class="acordion-item-label" for="content-Store data using Volumes">
            Store data using Volumes
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Kubernetes Client">
        <label class="acordion-item-label" for="content-Kubernetes Client">
            Kubernetes Client
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Security RBAC">
        <label class="acordion-item-label" for="content-Security RBAC">
            Security RBAC
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Kubernetes Package manager">
        <label class="acordion-item-label" for="content-Kubernetes Package manager">
            Kubernetes Package manager
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Kubernetes cluster for Production grade">
        <label class="acordion-item-label" for="content-Kubernetes cluster for Production grade">
            Kubernetes cluster for Production grade
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Service mesh with istio">
        <label class="acordion-item-label" for="content-Service mesh with istio">
            Service mesh with istio
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
              
                
                
                



<div class="accordion-container">
    <div class="acordion-item">
        <input type="checkbox" id="content-Kubernetes on Cloud provider">
        <label class="acordion-item-label" for="content-Kubernetes on Cloud provider">
            Kubernetes on Cloud provider
        </label>
        <div class="acordion-item-content">
            <ul>
            
            <li>
                <a href="#!">Materi belum tersedia</a>
            </li>
            
            </ul>
        </div>
    </div>
</nav>
                
                      
          
        </aside>
        
        <p>Hai semuanya, di materi study cases untuk Pod and Container specification kali ini adalah lanjutan dari sebelumnya yang lebih advanced lagi yaitu Create and build microservices dengan framework Springboot Rest API dengan architecture seperti berikut:</p>

<p><img src="/resources/posts/kubernetes/04b-study-cases-microservice-apps/microservice-architecture.png" alt="architecture-deploy" /></p>

<p>Okay nah terlihat sedikit berbeda dengan application monolith sebelumnya, disini setiap service akan saling berkomunikasi dengan menggunakan protocol yang lightweight (ringan) seperti Rest API, grpc, messaging bus, database shared dan lain-lain. Pada study kasus kali ini terlihat pada diagram tersebut masih menggunakan physical / virtual-machine deployement kita akan migrasikan menggunakan orchestration container system dengan Kubernetes. Adapun tahap-tahap yang perlu kita lakukan yaitu</p>

<ol>
  <li>Develop aplikasi</li>
  <li>How code works (Code Review)</li>
  <li>The new architecture for orchestration container system</li>
  <li>Containerize apps</li>
  <li>Deploy to Kubernetes
    <ol>
      <li>Running as a Pod with namespace</li>
      <li>Connecting other service from the another namespace</li>
      <li>Specify container probes (health check)</li>
      <li>Specify resource request and limit</li>
    </ol>
  </li>
  <li>Implement API Gateway using nginx reverse proxy</li>
</ol>

<p>Ok tanpa berlama-lama yuk langsung aja kita bahas materi yang pertama:</p>

<!--more-->

<h2 id="development-aplikasi">Development aplikasi</h2>

<p>Dalam mendevelop aplikasi, ada beberapa hal yang perlu di persiapakan yaitu Software Development Kit dan backing service seperti Database, source-code version control dan DevTools yaitu</p>

<ol>
  <li>Git</li>
  <li>Java Development Kit (JDK) versi 17 keatas</li>
  <li>MySQL Database</li>
  <li>PostgreSQL Database</li>
  <li>Apache Maven</li>
  <li>Text editor seperti InteliJ IDEA, Visual Studio Code dan lain-lain</li>
  <li>Rest API client seperti Postman, curl dan lain-lain</li>
  <li>Docker</li>
</ol>

<p>Jadi temen-temen perlu install software development kita tersebut untuk cara installnya sudah pernah saya bahas di kelas <a href="https://youtube.dimas-maryanto.com/posts/devops/docker/dockerfile/study-cases/08c-build-springboot">DevOps - Docker untuk Pemula s/d Mahir</a>. Jika sudah temen bisa check dengan command seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » java <span class="nt">-version</span>
java version <span class="s2">"19.0.1"</span> 2022-10-18
Java<span class="o">(</span>TM<span class="o">)</span> SE Runtime Environment <span class="o">(</span>build 19.0.1+10-21<span class="o">)</span>
Java HotSpot<span class="o">(</span>TM<span class="o">)</span> 64-Bit Server VM <span class="o">(</span>build 19.0.1+10-21, mixed mode, sharing<span class="o">)</span>

~ » mvn <span class="nt">-v</span>
Apache Maven 3.9.0 <span class="o">(</span>9b58d2bad23a66be161c4664ef21ce219c2c8584<span class="o">)</span>
Maven home: /usr/local/Cellar/maven/3.9.0/libexec
Java version: 19.0.1, vendor: Oracle Corporation, runtime: /Library/Java/JavaVirtualMachines/jdk-19.jdk/Contents/Home
Default locale: en_ID, platform encoding: UTF-8
OS name: <span class="s2">"mac os x"</span>, version: <span class="s2">"13.2"</span>, <span class="nb">arch</span>: <span class="s2">"x86_64"</span>, family: <span class="s2">"mac"</span>

~ » psql <span class="nt">--version</span>
psql <span class="o">(</span>PostgreSQL<span class="o">)</span> 14.7 <span class="o">(</span>Homebrew<span class="o">)</span>

~ » mysql <span class="nt">--version</span>
mysql  Ver 8.0.32 <span class="k">for </span>macos13.0 on x86_64 <span class="o">(</span>Homebrew<span class="o">)</span>

~ » curl <span class="nt">--version</span>
curl 7.86.0 <span class="o">(</span>x86_64-apple-darwin22.0<span class="o">)</span> libcurl/7.86.0 <span class="o">(</span>SecureTransport<span class="o">)</span> LibreSSL/3.3.6 zlib/1.2.11 nghttp2/1.47.0
Release-Date: 2022-10-26
</code></pre></div></div>

<p>Setelah temen-temen menginstall semua Software Development Kit, kemudian yang kita butuhkan adalah source-code. Untuk source-code temen-temen bisa clone dari <a href="https://github.com/DevOpsWithDimas/kubernetes-springboot-microservice-apps">github repo berikut</a> perintahnya seperti berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone git@github.com:DevOpsWithDimas/kubernetes-springboot-microservice-apps.git</code></pre></figure>

<p>Setelah di clone kita coba jalankan projectnya, tetapi pertama kita perlu configure dulu databasenya. supaya gak ribet kita akan menggunakan <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> seperti berikut:</p>

<script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-docker-compose.depedency.yaml"> </script>

<p>Kemudian coba jalankan dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker compose up <span class="nt">-d</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
docker compose ps</code></pre></figure>

<p>Maka hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>devops/k8s-springboot-microservice <span class="o">[</span>main●] » docker compose ps
NAME                                     IMAGE               COMMAND                  SERVICE             CREATED             STATUS              PORTS
k8s-springboot-microservice-mysql-1      mysql:8.0           <span class="s2">"docker-entrypoint.s…"</span>   mysql               47 seconds ago      Up 41 seconds       0.0.0.0:3306-&gt;3306/tcp, 33060/tcp
k8s-springboot-microservice-postgres-1   postgres:15         <span class="s2">"docker-entrypoint.s…"</span>   postgres            47 seconds ago      Up 42 seconds       0.0.0.0:5432-&gt;5432/tcp
</code></pre></div></div>

<p>Setelah semua database running, sekarang kita jalankan masing-masing service dengan menggunakan perintah <code class="language-plaintext highlighter-rouge">mvn clean -pl &lt;module-name&gt; spring-boot:run</code> seperti berikut</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mvn clean <span class="nt">-pl</span> customer spring-boot:run</code></pre></figure>

<p>maka outputnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>devops/k8s-springboot-microservice <span class="o">[</span>main●] » mvn clean <span class="nt">-pl</span> customer spring-boot:run
  <span class="nb">.</span>   ____          _            __ _ _
 /<span class="se">\\</span> / ___<span class="s1">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ | <span class="s1">'_| | '</span>_ <span class="se">\/</span> _<span class="sb">`</span> | <span class="se">\ \ \ \</span>
 <span class="se">\\</span>/  ___<span class="o">)</span>| |_<span class="o">)</span>| | | | | <span class="o">||</span> <span class="o">(</span>_| |  <span class="o">)</span> <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
  <span class="s1">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.0.2)

2023-02-12T12:05:11.295+07:00  INFO 9448 --- [  restartedMain] c.m.d.udemy.customer.MainApplication     : Starting MainApplication using Java 19.0.1 with PID 9448 (/Users/dimasm93/Developer/dimas-maryanto.com/youtube/_projects/devops/k8s-springboot-microservice/customer/target/classes started by dimasm93 in /Users/dimasm93/Developer/dimas-maryanto.com/youtube/_projects/devops/k8s-springboot-microservice/customer)
2023-02-12T12:05:11.298+07:00  INFO 9448 --- [  restartedMain] c.m.d.udemy.customer.MainApplication     : No active profile set, falling back to 1 default profile: "default"
2023-02-12T12:05:11.392+07:00  INFO 9448 --- [  restartedMain] .e.DevToolsPropertyDefaultsPostProcessor : Devtools property defaults active! Set '</span>spring.devtools.add-properties<span class="s1">' to '</span><span class="nb">false</span><span class="s1">' to disable

2023-02-12T12:05:13.303+07:00  INFO 9448 --- [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 9090 (http)
2023-02-12T12:05:13.319+07:00  INFO 9448 --- [  restartedMain] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2023-02-12T12:05:13.319+07:00  INFO 9448 --- [  restartedMain] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.5]
2023-02-12T12:05:13.400+07:00  INFO 9448 --- [  restartedMain] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2023-02-12T12:05:13.402+07:00  INFO 9448 --- [  restartedMain] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 2007 ms
2023-02-12T12:05:13.612+07:00  INFO 9448 --- [  restartedMain] o.f.c.internal.license.VersionPrinter    : Flyway Community Edition 9.5.1 by Redgate
2023-02-12T12:05:14.208+07:00  INFO 9448 --- [  restartedMain] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2023-02-12T12:05:14.248+07:00  INFO 9448 --- [  restartedMain] o.f.c.i.database.base.BaseDatabaseType   : Database: jdbc:mysql://localhost:3306/customer4p1 (MySQL 8.0)
2023-02-12T12:05:14.373+07:00  INFO 9448 --- [  restartedMain] o.f.core.internal.command.DbValidate     : Successfully validated 1 migration (execution time 00:00.030s)
2023-02-12T12:05:14.435+07:00  INFO 9448 --- [  restartedMain] o.f.c.i.s.JdbcTableSchemaHistory         : Creating Schema History table `customer4p1`.`flyway_schema_history` ...
2023-02-12T12:05:14.575+07:00  INFO 9448 --- [  restartedMain] o.f.core.internal.command.DbMigrate      : Current version of schema `customer4p1`: &lt;&lt; Empty Schema &gt;&gt;
2023-02-12T12:05:14.590+07:00  INFO 9448 --- [  restartedMain] o.f.core.internal.command.DbMigrate      : Migrating schema `customer4p1` to version "20230211170102 - schema-customer"
2023-02-12T12:05:14.694+07:00  INFO 9448 --- [  restartedMain] o.f.core.internal.command.DbMigrate      : Successfully applied 1 migration to schema `customer4p1`, now at version v20230211170102 (execution time 00:00.131s)
2023-02-12T12:05:14.806+07:00  INFO 9448 --- [  restartedMain] o.hibernate.jpa.internal.util.LogHelper  : HHH000204: Processing PersistenceUnitInfo [name: default]
2023-02-12T12:05:16.662+07:00  INFO 9448 --- [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 9090 (http) with context path ''
2023-02-12T12:05:16.666+07:00  INFO 9448 --- [  restartedMain] o.s.b.d.a.OptionalLiveReloadServer       : LiveReload server is running on port 35729
2023-02-12T12:05:16.686+07:00  WARN 9448 --- [  restartedMain] JpaBaseConfiguration$JpaWebConfiguration : spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2023-02-12T12:05:16.706+07:00  INFO 9448 --- [  restartedMain] c.m.d.udemy.customer.MainApplication     : Started MainApplication in 6.034 seconds (process running for 6.653)
</span></code></pre></div></div>

<p>Sekarang kita coba check service custemer bisa meresponse api yang kita request dengan menggunakan perintah curl seperti berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">--location</span> <span class="nt">--request</span> GET <span class="s1">'localhost:9090/api/customer/v1/findById/cust01'</span></code></pre></figure>

<p>Maka jika dijalankan outputnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Last login: Sun Feb 12 11:33:28 on ttys002
~ » curl <span class="nt">--location</span> <span class="nt">--request</span> GET <span class="s1">'localhost:9090/api/customer/v1/findById/cust01'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, GET is already inferred.
<span class="k">*</span>   Trying 127.0.0.1:9090...
<span class="k">*</span> Connected to localhost <span class="o">(</span>127.0.0.1<span class="o">)</span> port 9090 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /api/customer/v1/findById/cust01 HTTP/1.1
&lt; HTTP/1.1 200
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 12 Feb 2023 05:12:26 GMT

<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"cust01"</span>,<span class="s2">"userId"</span>:<span class="s2">"dimasm93"</span>,<span class="s2">"fullname"</span>:<span class="s2">"Dimas Maryanto"</span>,<span class="s2">"alamat"</span>:<span class="s2">"Bandung, Jawa Barat"</span><span class="o">}</span>%
</code></pre></div></div>

<p>Itu artinya sudah ok, selanjutnya kita coba jalankan service order dengan perintah seperti berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mvn clean <span class="nt">-pl</span> orders spring-boot:run</code></pre></figure>

<p>Maka outputnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>devops/k8s-springboot-microservice <span class="o">[</span>main●] » mvn clean <span class="nt">-pl</span> orders spring-boot:run
  <span class="nb">.</span>   ____          _            __ _ _
 /<span class="se">\\</span> / ___<span class="s1">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ | <span class="s1">'_| | '</span>_ <span class="se">\/</span> _<span class="sb">`</span> | <span class="se">\ \ \ \</span>
 <span class="se">\\</span>/  ___<span class="o">)</span>| |_<span class="o">)</span>| | | | | <span class="o">||</span> <span class="o">(</span>_| |  <span class="o">)</span> <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
  <span class="s1">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.0.2)

2023-02-12T12:16:07.346+07:00  INFO 11255 --- [  restartedMain] c.m.dimas.udemy.orders.MainApplication   : Starting MainApplication using Java 19.0.1 with PID 11255 (/Users/dimasm93/Developer/dimas-maryanto.com/youtube/_projects/devops/k8s-springboot-microservice/orders/target/classes started by dimasm93 in /Users/dimasm93/Developer/dimas-maryanto.com/youtube/_projects/devops/k8s-springboot-microservice/orders)
2023-02-12T12:16:07.350+07:00  INFO 11255 --- [  restartedMain] c.m.dimas.udemy.orders.MainApplication   : No active profile set, falling back to 1 default profile: "default"
2023-02-12T12:16:09.296+07:00  INFO 11255 --- [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 9091 (http)
2023-02-12T12:16:09.322+07:00  INFO 11255 --- [  restartedMain] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2023-02-12T12:16:09.608+07:00  INFO 11255 --- [  restartedMain] o.f.c.internal.license.VersionPrinter    : Flyway Community Edition 9.5.1 by Redgate
2023-02-12T12:16:10.187+07:00  INFO 11255 --- [  restartedMain] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2023-02-12T12:16:10.217+07:00  INFO 11255 --- [  restartedMain] o.f.c.i.database.base.BaseDatabaseType   : Database: jdbc:postgresql://localhost:5432/order4p1 (PostgreSQL 15.2)
2023-02-12T12:16:10.364+07:00  INFO 11255 --- [  restartedMain] o.f.core.internal.command.DbValidate     : Successfully validated 1 migration (execution time 00:00.047s)
2023-02-12T12:16:10.460+07:00  INFO 11255 --- [  restartedMain] o.f.c.i.s.JdbcTableSchemaHistory         : Creating Schema History table "public"."flyway_schema_history" ...
2023-02-12T12:16:10.605+07:00  INFO 11255 --- [  restartedMain] o.f.core.internal.command.DbMigrate      : Current version of schema "public": &lt;&lt; Empty Schema &gt;&gt;
2023-02-12T12:16:10.627+07:00  INFO 11255 --- [  restartedMain] o.f.core.internal.command.DbMigrate      : Migrating schema "public" to version "20230211171555 - create-order"
2023-02-12T12:16:10.696+07:00  INFO 11255 --- [  restartedMain] o.f.core.internal.command.DbMigrate      : Successfully applied 1 migration to schema "public", now at version v20230211171555 (execution time 00:00.107s)
2023-02-12T12:16:12.807+07:00  INFO 11255 --- [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 9091 (http) with context path ''
2023-02-12T12:16:12.813+07:00  WARN 11255 --- [  restartedMain] o.s.b.d.a.OptionalLiveReloadServer       : Unable to start LiveReload server
2023-02-12T12:16:12.866+07:00  INFO 11255 --- [  restartedMain] c.m.dimas.udemy.orders.MainApplication   : Started MainApplication in 6.225 seconds (process running for 6.76)
</span></code></pre></div></div>

<p>Sekarang kita coba check service order dengan menggunakan perintah curl berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl <span class="nt">--location</span> <span class="nt">--request</span> POST <span class="s1">'localhost:9091/api/order/v1/checkout'</span> <span class="se">\</span>
<span class="nt">--header</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
<span class="nt">--data-raw</span> <span class="s1">'{
    "userId": "cust01",
    "item": "Macbook Pro 13\" (A1723)",
    "qty": "2"
}'</span> <span class="nt">-v</span>

Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 127.0.0.1:9091...
<span class="k">*</span> Connected to localhost <span class="o">(</span>127.0.0.1<span class="o">)</span> port 9091 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> POST /api/order/v1/checkout HTTP/1.1
<span class="o">&gt;</span> Content-Type: application/json
<span class="o">&gt;</span> Content-Length: 82
<span class="o">&gt;</span>
<span class="k">*</span> Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200
&lt; Content-Type: application/json
&lt; Date: Sun, 12 Feb 2023 05:19:32 GMT

<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"1a02d9bd-8413-43f8-b6ac-bf3b7f8f3438"</span>,<span class="s2">"createdDate"</span>:<span class="s2">"2023-02-12T12:19:31.905439"</span>,<span class="s2">"customer"</span>:<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"cust01"</span>,<span class="s2">"userId"</span>:<span class="s2">"dimasm93"</span>,<span class="s2">"fullname"</span>:<span class="s2">"Dimas Maryanto"</span>,<span class="s2">"alamat"</span>:<span class="s2">"Bandung, Jawa Barat"</span><span class="o">}</span>,<span class="s2">"item"</span>:<span class="s2">"Macbook Pro 13</span><span class="se">\"</span><span class="s2"> (A1723)"</span>,<span class="s2">"qty"</span>:2<span class="o">}</span>%</code></pre></figure>

<p>Ok ini artinya sudah okay semua.</p>

<h2 id="how-code-works-code-review">How code works (Code Review)</h2>

<p>Setelah kita mencoba menjalankan program tersebut tahap selanjutnya adalah memahami bagaimana aplikasi bisa running dengan cara code review. Hal ini juga menjadi yang terpenting ketika proses deliver dari Programmer/Developer ke DevOps Engineer untuk di deploy ke environment.</p>

<p>Sebagai seorang DevOps kita harus mengetahui dan mengerti setiap service dari microservice yang telah di deliver oleh programmer untuk di implementasikan, Dengan cara melakukan assesment, diskusi, atau technical meeting dengan team Developer/Programmer. Salah satu prosedure yang biasanya saya lakukan adalah</p>

<ol>
  <li>Developer/Programmer menjelaskan overview architecture service</li>
  <li>Developer/Programmer menjelaskan service communication</li>
  <li>Developer/Programmer menjelaskan how to configure communication between service</li>
  <li>DevOps menyimpulkan &amp; Memberikan saran terkait perancangan architecture baru</li>
  <li>DevOps mengimplementasikan perancangan architecture tersebut ke environment</li>
  <li>Developer/Programmer dan DevOps melakukan Testing functional secara berdampingan</li>
  <li>DevOps melakukan Performance/Stress testing</li>
</ol>

<p>Okay kita tidak akan membahas semuanya ya, karena keterbatasan waktu. Jadi kita bahas beberapa yang dirasa penting seperti point no <code class="language-plaintext highlighter-rouge">1</code>, <code class="language-plaintext highlighter-rouge">2</code>, <code class="language-plaintext highlighter-rouge">3</code>, dan <code class="language-plaintext highlighter-rouge">4</code>. Pada point no 1, kita sudah bahas dibahas section awal jadi kita skip. Selanjutnya kita bahas point no 2 yaitu Service Communication.</p>

<p>Service communication ini pada dasarnya menjelaskan setiap service memiliki dependency ke mana saja dan seperti apa komunikasinya. Pada dasarnya service communication ada beberapa cara yaitu menggunakan Shared Database, Rest API, RPC (khususnya grpc), dan Messaging bus. Untuk service <code class="language-plaintext highlighter-rouge">customer</code> dan <code class="language-plaintext highlighter-rouge">orders</code> ini basicly kita menggunakan Rest API, Okay untuk lebih jelas kita lihat diagram berikut:</p>

<ol>
  <li>
    <p>Customer API - find by id
  <img src="/resources/posts/kubernetes/04b-study-cases-microservice-apps/01-flow-customer-findbyid.png" alt="customer-findbyid" /></p>
  </li>
  <li>
    <p>Orders API - create new order
  <img src="/resources/posts/kubernetes/04b-study-cases-microservice-apps/02-flow-create-new-orders.png" alt="create-new-order" /></p>
  </li>
</ol>

<p>Jadi klo kita perhatikan diagram no 1, flownya sangat simple hanya menggunakan database tetapi untuk no 2 selain database perlu call service customerAPI melalui Rest API. Yang jadi pertanyaan selanjutnya bagaimana konfigurasi koneksinya? Okay sekarang kita coba bedah kodingnya / code review.</p>

<p>Kalo kita lihat di project <code class="language-plaintext highlighter-rouge">orders</code> seperti berikut:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// orders/src/main/java/com/maryanto/dimas/udemy/orders/controller/OrderController.java</span>
<span class="kn">package</span> <span class="nn">com.maryanto.dimas.udemy.orders.controller</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/order/v1"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>

  <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/checkout"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;?&gt;</span> <span class="n">placeOrder</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">RequestOrderDTO</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">CustomerDTO</span><span class="o">&gt;</span> <span class="n">responseCustomer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">serviceCustomer</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">responseCustomer</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">badRequest</span><span class="o">().</span><span class="na">body</span><span class="o">(</span><span class="s">"Customer not found!"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">CustomerDTO</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">responseCustomer</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="nc">Order</span> <span class="n">purchaseOrder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">();</span>
        <span class="c1">// set value here!</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">purchaseOrder</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">repo</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">purchaseOrder</span><span class="o">);</span>
          <span class="nc">OrderDTO</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderDTO</span><span class="o">();</span>
          <span class="c1">// set value here!</span>
          <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Can't proses checkout"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">internalServerError</span><span class="o">()</span>
              <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="s">"Transaction can't be processed!!! \nPlease report to adminstrator"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// orders/src/main/java/com/maryanto/dimas/udemy/orders/service/CustomerService.java</span>
<span class="kn">package</span> <span class="nn">com.maryanto.dimas.udemy.orders.service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerService</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="kd">public</span> <span class="nf">CustomerService</span><span class="o">(</span>
          <span class="nc">RestTemplate</span> <span class="n">rest</span><span class="o">,</span>
          <span class="nd">@Value</span><span class="o">(</span><span class="s">"${services.customer.host}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">host</span><span class="o">,</span>
          <span class="nd">@Value</span><span class="o">(</span><span class="s">"${services.customer.port}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">port</span><span class="o">,</span>
          <span class="nd">@Value</span><span class="o">(</span><span class="s">"${services.customer.proto}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">proto</span><span class="o">,</span>
          <span class="nd">@Value</span><span class="o">(</span><span class="s">"${services.customer.context-path}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">contextPath</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">customerHost</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">customerPort</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">customerProto</span> <span class="o">=</span> <span class="n">proto</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">customerContextPath</span> <span class="o">=</span> <span class="n">contextPath</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">rest</span> <span class="o">=</span> <span class="n">rest</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">CustomerDTO</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">baseUrl</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
              <span class="s">"%s://%s:%s%s/api/customer/v1/findById/"</span><span class="o">,</span>
              <span class="k">this</span><span class="o">.</span><span class="na">customerProto</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">customerHost</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">customerPort</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">customerContextPath</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">rest</span><span class="o">.</span><span class="na">getForEntity</span><span class="o">(</span><span class="n">baseUrl</span> <span class="o">+</span> <span class="s">"{userId}"</span><span class="o">,</span> <span class="nc">CustomerDTO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Dan selain itu juga, berikut adalah file <code class="language-plaintext highlighter-rouge">application.yaml</code> untuk menyimpan semua environment variable yang dipanggil pada source code tersebut:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># orders/src/main/resources/application.yaml</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">customer</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">${SERVICE_CUSTOMER_HOST:localhost}</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">${SERVICE_CUSTOMER_PORT:9090}</span>
    <span class="na">context-path</span><span class="pi">:</span> <span class="s">${SERVICE_CUSTOMER_CONTEXT_PATH:}</span>
    <span class="na">proto</span><span class="pi">:</span> <span class="s">${SERVICE_CUSTOMER_PROTO:http}</span></code></pre></figure>

<p>Okay sekarang perhatikan penggalan code diatas, jadi cara kita mengconfigurasi koneksi ke service <code class="language-plaintext highlighter-rouge">customerAPI</code> yaitu menggunakan envionment variable yang tertera pada <code class="language-plaintext highlighter-rouge">application.yaml</code> seperti <code class="language-plaintext highlighter-rouge">SERVICE_CUSTOMER_HOST</code>, <code class="language-plaintext highlighter-rouge">SERVICE_CUSTOMER_PORT</code>, <code class="language-plaintext highlighter-rouge">SERVICE_CUSTOMER_CONTEXT_PATH</code>, <code class="language-plaintext highlighter-rouge">SERVICE_CUSTOMER_PROTO</code> So kita bisa pasang/override nilainya pada saat dijalankan diatas container.</p>

<p>Nah setelah kita breakdown cara kerja atau code review, semoga temen-temen bisa memahami dan mulai merumuskan architecture yang bisa menunjang workload tersebut.</p>

<h2 id="the-new-architecture">The new architecture</h2>

<p>Setelah kita melihat, diskusi, technical meeting, serta code review tahap selanjutnya adalah merumuskan architecture yang sesuai dengan workload dari service tersebut.</p>

<p>Karena aplikasi yang dibuat merupakan microservice architecture yang memiliki backing service (dependency) seperti database, atau bahkan service lainnya Maka kita perlu buat scope dan boundaries dari services tersebut. Adapun scope dan boundaries tersebut dibagi menjadi Primary dan Secondary backing service</p>

<blockquote>
  <p><strong>Primary backing service</strong> yaitu Aplikasi yang tidak akan bisa startup ketika di running dalam suatu environment jika tanpa/menggunakan service tersebut (Mandatory), sedangkan <strong>Secondary backing service</strong> yaitu Aplikasi masih bisa berjalan tetapi secara functional belum lengkap.</p>
</blockquote>

<p>Karena tujuan kita adalah deploy ke orchestration container system menggunakan kubernetes jadi, langsung aja disini saya gambarkan menggunakan pendekatan kubernetes object resource seperti berikut:</p>

<p><img src="/resources/posts/kubernetes/04b-study-cases-microservice-apps/03-architecture-k8s-object.png" alt="architecture-k8s-objects" /></p>

<p>Berdasarkan diagram tersebut kita akan bagi menjadi 3 namespace yaitu <code class="language-plaintext highlighter-rouge">default</code>, <code class="language-plaintext highlighter-rouge">orders</code> dan <code class="language-plaintext highlighter-rouge">customer</code>. Dalam masing-masing namespace memiliki service yang kita pisahkan berdasarkan scopenya yaitu</p>

<ol>
  <li>Namespace <code class="language-plaintext highlighter-rouge">default</code>, terdiri dari pod dengan workload: <code class="language-plaintext highlighter-rouge">nginx</code> berfungsi untuk routing (API Gateway) ke service-service seperti <code class="language-plaintext highlighter-rouge">order</code> dan <code class="language-plaintext highlighter-rouge">customer</code></li>
  <li>Namespace <code class="language-plaintext highlighter-rouge">customer</code>, terdiri dari pod dengan workload: <code class="language-plaintext highlighter-rouge">customerAPI</code> dan <code class="language-plaintext highlighter-rouge">MySQL</code> sebagai primary backing service</li>
  <li>Namespace <code class="language-plaintext highlighter-rouge">order</code>, terdiri dari pod dengan workload: <code class="language-plaintext highlighter-rouge">orderAPI</code> dan <code class="language-plaintext highlighter-rouge">PostgreSQL</code> sebagai primary backing service.</li>
</ol>

<h2 id="containerize-apps">Containerize apps</h2>

<p>Setelah kita men-design architecturenya untuk deploy ke orchestration container system seperti kubernetes. Tahap awal meng-implementasikan semua konsep tersebut adalah melakukan kontainerisasi (container image). Di tahap ini adalah paling dasar sebelum kita deploy diatas kubernetes, jika service/aplikasi tidak bisa dibuild ke container image maka sudah dipastikan tidak akan bisa lanjut ke tahap selanjutnya.</p>

<p>Okay langsung aja kita mulai buat containernya. Tetapi sebelum itu kita lihat lagi bagaimana cara deploy manual seperti section sebelumnya. Apa yang kita perlukan untuk menjalankan service tersebut???</p>

<ol>
  <li>Java Development Kit (jdk-17 or later)</li>
  <li>Binary execute (jar)</li>
</ol>

<p>Untuk vendor JDK yang kita gunakan di local environment menggunakan Oracle JDK 19, nah ini sebisa mungkin untuk versi dari SDK harus sama persis dengan yang terdapat di container. Karena Oracle JDK tidak tersedia secara public di docker hub, kita akan menggunakan vendor yang open-source yaitu OpenJDK dengan version yang sama yaitu <a href="https://hub.docker.com/_/openjdk/tags?page=1&amp;name=19-oracle">openjdk-19</a></p>

<p>Sedangkan untuk binary execute atau file bundle yang telah dicomple kita bisa peroleh dengan menjalankan perintah:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mvn clean <span class="nt">-DskipTests</span> package</code></pre></figure>

<p>Jika dijalankan hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>devops/k8s-springboot-microservice <span class="o">[</span>main] » mvn clean <span class="nt">-DskipTests</span> package
<span class="o">[</span>INFO] Reactor Summary <span class="k">for </span>springboot-microservice 0.0.1-SNAPSHOT:
<span class="o">[</span>INFO] 
<span class="o">[</span>INFO] springboot-microservice ............................ SUCCESS <span class="o">[</span>  1.777 s]

<span class="o">[</span>INFO] <span class="nt">---</span> jar:3.3.0:jar <span class="o">(</span>default-jar<span class="o">)</span> @ customer-api <span class="nt">---</span>
<span class="o">[</span>INFO] Building jar: /Users/dimasm93/Developer/dimas-maryanto.com/youtube/_projects/devops/k8s-springboot-microservice/customer/target/customer-api.jar
<span class="o">[</span>INFO] customer-api ....................................... SUCCESS <span class="o">[</span>  6.182 s]

<span class="o">[</span>INFO] <span class="nt">---</span> jar:3.3.0:jar <span class="o">(</span>default-jar<span class="o">)</span> @ orders-api <span class="nt">---</span>
<span class="o">[</span>INFO] Building jar: /Users/dimasm93/Developer/dimas-maryanto.com/youtube/_projects/devops/k8s-springboot-microservice/orders/target/orders-api.jar
<span class="o">[</span>INFO] orders-api ......................................... SUCCESS <span class="o">[</span>  2.735 s]
<span class="o">[</span>INFO] <span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>INFO] BUILD SUCCESS
</code></pre></div></div>

<p>Okay setelah semua kebutuhan terpenuhi, tahap selanjutnya kita buat <code class="language-plaintext highlighter-rouge">Dockerfile</code> seperti berikut:</p>

<ol>
  <li>
    <p>Dockerfile untuk customerAPI, simpan dalam folder <code class="language-plaintext highlighter-rouge">customer/Dockerfile</code> seperti berikut:
  <script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-dockerfile-customer-api"> </script></p>
  </li>
  <li>
    <p>Dockerfile untuk orderAPI, simpan dalam folder <code class="language-plaintext highlighter-rouge">order/Dockerfile</code> seperti berikut:
  <script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-dockerfile-order-api"> </script></p>
  </li>
  <li>
    <p>Dan yang terakhir, tambahkan service <code class="language-plaintext highlighter-rouge">customerAPI</code> dan <code class="language-plaintext highlighter-rouge">orderAPI</code> dalam <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> seperti berikut:
  <script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-docker-compose-build.yaml"> </script></p>
  </li>
</ol>

<p>Sekerang coba jalankan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker compose build</code></pre></figure>

<p>Jika dijalankan hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>devops/k8s-springboot-microservice <span class="o">[</span>main] » docker compose build customerAPI orderAPI
<span class="o">[</span>+] Building 5.1s <span class="o">(</span>7/7<span class="o">)</span> FINISHED
<span class="o">=&gt;</span> <span class="o">[</span>internal] load metadata <span class="k">for </span>docker.io/library/openjdk:19-oraclelinux8                                                                  4.7s
 <span class="o">=&gt;</span> <span class="o">[</span>1/2] FROM docker.io/library/openjdk:19-oraclelinux8@sha256:a5f2327c217367af3729670628c7ad66799cd890bde4e14fad02c2ae59552424           0.0s
 <span class="o">=&gt;</span> <span class="o">[</span>internal] load build context                                                                                                          0.0s
 <span class="o">=&gt;</span> <span class="o">=&gt;</span> transferring context: 145B                                                                                                          0.0s
 <span class="o">=&gt;</span> CACHED <span class="o">[</span>2/2] ADD target/orders-api.jar spring-boot.jar                                                                                 0.0s
 <span class="o">=&gt;</span> exporting to image                                                                                                                     0.1s
 <span class="o">=&gt;</span> <span class="o">=&gt;</span> naming to repository.dimas-maryanto.com:8087/dimmaryanto93/example/order-api:latest

<span class="o">=&gt;</span> <span class="o">[</span>internal] load metadata <span class="k">for </span>docker.io/library/openjdk:19-oraclelinux8                                                                  4.7s
 <span class="o">=&gt;</span> <span class="o">[</span>1/2] FROM docker.io/library/openjdk:19-oraclelinux8@sha256:a5f2327c217367af3729670628c7ad66799cd890bde4e14fad02c2ae59552424           0.0s
 <span class="o">=&gt;</span> <span class="o">[</span>internal] load build context                                                                                                          0.0s
 <span class="o">=&gt;</span> <span class="o">=&gt;</span> transferring context: 145B  
<span class="o">=&gt;</span> CACHED <span class="o">[</span>2/2] ADD target/customer-api.jar spring-boot.jar                                                                                0.0s
 <span class="o">=&gt;</span> exporting to image                                                                                                                     1.8s
 <span class="o">=&gt;</span> <span class="o">=&gt;</span> naming to repository.dimas-maryanto.com:8087/dimmaryanto93/example/customer-api:latest

devops/k8s-springboot-microservice <span class="o">[</span>main] » docker images
REPOSITORY                                                              TAG           IMAGE ID       CREATED          SIZE
repository.dimas-maryanto.com:8087/dimmaryanto93/example/order-api      latest        f27ba96797db   17 minutes ago   522MB
repository.dimas-maryanto.com:8087/dimmaryanto93/example/customer-api   latest        9d589fe904f0   26 minutes ago   523MB
</code></pre></div></div>

<p>Setelah container image di build, sekarang coba jalankan dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker compose up <span class="nt">-d</span></code></pre></figure>

<p>Maka seperti berikut outputnya:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>devops/k8s-springboot-microservice <span class="o">[</span>main] » docker compose up <span class="nt">-d</span>
<span class="o">[</span>+] Running 7/7
 ⠿ Network k8s-springboot-microservice_default          Created        0.2s
 ⠿ Volume <span class="s2">"k8s-springboot-microservice_pg_data"</span>         Created        0.0s
 ⠿ Volume <span class="s2">"k8s-springboot-microservice_mysql_data"</span>      Created        0.0s
 ⠿ Container k8s-springboot-microservice-mysql-1        Started        3.2s
 ⠿ Container k8s-springboot-microservice-postgres-1     Started        3.0s
 ⠿ Container k8s-springboot-microservice-customerAPI-1  Started        4.9s
 ⠿ Container k8s-springboot-microservice-orderAPI-1     Started        4.9s

devops/k8s-springboot-microservice <span class="o">[</span>main] » docker compose ps
NAME                                     IMAGE                                                                       COMMAND                  SERVICE             CREATED              STATUS              PORTS
k8s-springboot-microservice-mysql-1      repository.dimas-maryanto.com:8086/mysql:8.0                                <span class="s2">"docker-entrypoint.s…"</span>   mysql               About a minute ago   Up 58 seconds       0.0.0.0:3306-&gt;3306/tcp, 33060/tcp
k8s-springboot-microservice-orderAPI-1   repository.dimas-maryanto.com:8087/dimmaryanto93/example/order-api:latest   <span class="s2">"java -Djava.securit…"</span>   orderAPI            About a minute ago   Up 56 seconds       0.0.0.0:9091-&gt;9091/tcp
k8s-springboot-microservice-postgres-1   repository.dimas-maryanto.com:8086/postgres:15                              <span class="s2">"docker-entrypoint.s…"</span>   postgres            About a minute ago   Up 58 seconds       0.0.0.0:5432-&gt;5432/tcp
</code></pre></div></div>

<p>Jika semua service sudah running dengan baik, sekarang coba temen-temen test lagi service tersebut apakah berjalan dengan baik di atas single container? jika sudah ok. Yeeey selamat temen-temen udah melewati level 1.</p>

<p>Berikutnya adalah temen-temen bisa push ke container registry. boleh ke DockerHub atau private registry dengan menggunakan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker compose push customerAPI <span class="o">&amp;&amp;</span> <span class="se">\</span>
docker compose push orderAPI </code></pre></figure>

<h2 id="create-kubernetes-cluster-on-local">Create kubernetes cluster on local</h2>

<p>Setelah container image di-build dan publish ke container registry, tahap selanjutnya adalah deploy ke kubernetes cluster. Tetapi sebelum itu siapkan dulu kubernetes cluster untuk workload tersebut. Settingan cluster untuk microservice ini agak berbeda dengan sebelumnya yaitu seperti berikut:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">nodes</span><span class="pi">:</span> 
  <span class="na">controlplane</span><span class="pi">:</span> 
    <span class="na">cpus</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2</span><span class="nv"> </span><span class="s">cores'</span>
    <span class="na">memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2</span><span class="nv"> </span><span class="s">GB'</span>
  <span class="na">worker-1</span><span class="pi">:</span>
    <span class="na">cpus</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2</span><span class="nv"> </span><span class="s">cores'</span>
    <span class="na">memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">4</span><span class="nv"> </span><span class="s">GB'</span>
  <span class="na">worker-2</span><span class="pi">:</span>
    <span class="na">cpus</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2</span><span class="nv"> </span><span class="s">cores'</span>
    <span class="na">memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">4</span><span class="nv"> </span><span class="s">GB'</span>
</code></pre></div></div>

<p>Jadi kita akan buat menggunakan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">minikube start <span class="nt">-p</span> springboot-microservice <span class="se">\</span>
<span class="nt">--cpus</span> 2 <span class="se">\</span>
<span class="nt">--memory</span> 4G <span class="se">\</span>
<span class="nt">--insecure-registry</span> 192.168.88.50:8086 <span class="se">\</span>
<span class="nt">--nodes</span> 3

minikube profile springboot-microservice

minikube addons <span class="nb">enable </span>registry-creds <span class="o">&amp;&amp;</span> <span class="se">\</span>
minikube addons configure registry-creds

minikube addons <span class="nb">enable </span>metrics-server</code></pre></figure>

<p>Jika dijalankan hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » minikube start <span class="nt">-p</span> springboot-microservice <span class="se">\</span>
<span class="nt">--cpus</span> 2 <span class="se">\</span>
<span class="nt">--memory</span> 4G <span class="se">\</span>
<span class="nt">--insecure-registry</span> 192.168.88.50:8086 <span class="se">\</span>
<span class="nt">--nodes</span> 3
😄  <span class="o">[</span>springboot-microservice] minikube v1.29.0 on Darwin 13.2.1
✨  Using the hyperkit driver based on user configuration
👍  Starting control plane node springboot-microservice <span class="k">in </span>cluster springboot-microservice
🔥  Creating hyperkit VM <span class="o">(</span><span class="nv">CPUs</span><span class="o">=</span>2, <span class="nv">Memory</span><span class="o">=</span>4096MB, <span class="nv">Disk</span><span class="o">=</span>20000MB<span class="o">)</span> ...
📦  Preparing Kubernetes v1.26.1 on containerd 1.6.15 ...
    ▪ Generating certificates and keys ...
    ▪ Booting up control plane ...
    ▪ Configuring RBAC rules ...
🔗  Configuring CNI <span class="o">(</span>Container Networking Interface<span class="o">)</span> ...
    ▪ Using image gcr.io/k8s-minikube/storage-provisioner:v5
🔎  Verifying Kubernetes components...
🌟  Enabled addons: default-storageclass, storage-provisioner

👍  Starting worker node springboot-microservice-m02 <span class="k">in </span>cluster springboot-microservice
🔥  Creating hyperkit VM <span class="o">(</span><span class="nv">CPUs</span><span class="o">=</span>2, <span class="nv">Memory</span><span class="o">=</span>4096MB, <span class="nv">Disk</span><span class="o">=</span>20000MB<span class="o">)</span> ...

👍  Starting worker node springboot-microservice-m03 <span class="k">in </span>cluster springboot-microservice
🔥  Creating hyperkit VM <span class="o">(</span><span class="nv">CPUs</span><span class="o">=</span>2, <span class="nv">Memory</span><span class="o">=</span>4096MB, <span class="nv">Disk</span><span class="o">=</span>20000MB<span class="o">)</span> ...

🔎  Verifying Kubernetes components...
🏄  Done! kubectl is now configured to use <span class="s2">"springboot-microservice"</span> cluster and <span class="s2">"default"</span> namespace by default

~ » minikube profile springboot-microservice
✅  minikube profile was successfully <span class="nb">set </span>to springboot-microservice

~ » minikube addons <span class="nb">enable </span>registry-creds
❗  registry-creds is a 3rd party addon and is not maintained or verified by minikube maintainers, <span class="nb">enable </span>at your own risk.
❗  registry-creds does not currently have an associated maintainer.
    ▪ Using image docker.io/upmcenterprises/registry-creds:1.10
🌟  The <span class="s1">'registry-creds'</span> addon is enabled

~ » minikube addons configure registry-creds
Do you want to <span class="nb">enable </span>AWS Elastic Container Registry? <span class="o">[</span>y/n]: n

Do you want to <span class="nb">enable </span>Google Container Registry? <span class="o">[</span>y/n]: n

Do you want to <span class="nb">enable </span>Docker Registry? <span class="o">[</span>y/n]: y
<span class="nt">--</span> Enter docker registry server url: 192.168.88.50:8086
<span class="nt">--</span> Enter docker registry username: admin
<span class="nt">--</span> Enter docker registry password:

Do you want to <span class="nb">enable </span>Azure Container Registry? <span class="o">[</span>y/n]: n
✅  registry-creds was successfully configured

~ » kubectl get node
NAME                          STATUS   ROLES           AGE     VERSION
springboot-microservice       Ready    control-plane   4m52s   v1.26.1
springboot-microservice-m02   Ready    &lt;none&gt;          3m4s    v1.26.1
springboot-microservice-m03   Ready    &lt;none&gt;          86s     v1.26.1

~ » minikube addons <span class="nb">enable </span>metrics-server
💡  metrics-server is an addon maintained by Kubernetes. For any concerns contact minikube on GitHub.
You can view the list of minikube maintainers at: https://github.com/kubernetes/minikube/blob/master/OWNERS
    ▪ Using image registry.k8s.io/metrics-server/metrics-server:v0.6.2
🌟  The <span class="s1">'metrics-server'</span> addon is enabled
</code></pre></div></div>

<p>Jika pada pod <code class="language-plaintext highlighter-rouge">registry-creds</code> error, temen-temen bisa menggunakan alternative lain yaitu dengan membuat sebuah secret dengan perintah serperti berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl create secret docker-registry regcred <span class="se">\</span>
<span class="nt">--docker-server</span><span class="o">=</span>&lt;your-registry-server&gt; <span class="se">\</span>
<span class="nt">--docker-username</span><span class="o">=</span>&lt;your-name&gt; <span class="se">\</span>
<span class="nt">--docker-password</span><span class="o">=</span>&lt;your-pword&gt; <span class="se">\</span>
<span class="nt">--docker-email</span><span class="o">=</span>&lt;your-email&gt;</code></pre></figure>

<p>where:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;your-registry-server&gt;</code> is your Private Docker Registry FQDN. Use <code class="language-plaintext highlighter-rouge">https://index.docker.io/v1/</code> for DockerHub otherwise <code class="language-plaintext highlighter-rouge">192.168.88.50:8086</code> for private registry</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;your-name&gt;</code> is your Docker username.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;your-pword&gt;</code> is your Docker password.</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;your-email&gt;</code> is your Docker email.</li>
</ul>

<p>Dan setelah itu, jika mau menjalankan pod dari insecure registry temen-temen perlu nambahkan property <code class="language-plaintext highlighter-rouge">imagePullSecrets</code> seperti berikut contohnya:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">private-reg</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">private-reg-container</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">&lt;your-private-image&gt;</span>
  <span class="na">imagePullSecrets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">regcred</span></code></pre></figure>

<p>Setelah cluster kubernetes ready, kita coba membuat simple 2 pod yang simple menggunakan <code class="language-plaintext highlighter-rouge">nginx</code> dan <code class="language-plaintext highlighter-rouge">httpd</code> setelah itu kita coba test cni antara ke dua pod tersebut dengan perintah seperti berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl run web1 <span class="nt">--image</span> 192.168.88.50:8086/nginx:mainline <span class="nt">--port</span> 80 <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl expose pod/web1 <span class="nt">--port</span> 80 <span class="nt">--type</span> ClusterIP

kubectl run web2 <span class="nt">--image</span> 192.168.88.50:8086/httpd:latest <span class="nt">--port</span> 80 <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl expose pod/web2 <span class="nt">--port</span> 80 <span class="nt">--type</span> ClusterIP

kubectl <span class="nb">exec </span>web1 <span class="nt">--</span> curl http://web2</code></pre></figure>

<p>Jika dijalankan maka hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl run web1 <span class="nt">--image</span> 192.168.88.50:8086/nginx:mainline <span class="nt">--port</span> 80 <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl expose pod/web1 <span class="nt">--port</span> 80 <span class="nt">--type</span> ClusterIP
pod/web1 created
service/web1 exposed

~ » kubectl get pod
NAME   READY   STATUS              RESTARTS   AGE
web1   1/1     Running             0          56s

~ » kubectl run web2 <span class="nt">--image</span> 192.168.88.50:8086/httpd:latest <span class="nt">--port</span> 80 <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl expose pod/web2 <span class="nt">--port</span> 80 <span class="nt">--type</span> ClusterIP
pod/web2 created
service/web2 exposed

~ » kubectl get pod
NAME   READY   STATUS              RESTARTS   AGE
web1   1/1     Running             0          71s
web2   1/1     Running             0          30s

~ » kubectl <span class="nb">exec </span>web1 <span class="nt">--</span> curl http://web2
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    45  100    45    0     0    918      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:&lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
<span class="nt">--</span> <span class="nt">--</span>:--:--   918
</code></pre></div></div>

<p>Jika temen-temen perhatikan pada saat membuat cluster, mengapa cluster ini menggunakan memory yang lebih besar yaitu <code class="language-plaintext highlighter-rouge">4G</code> di setiap nodenya, Jadi menentukan resource tidak hanya di sisi Pod dan Containernya saja tetapi juga pada cluster nodenya juga kita harus sesuaikan.</p>

<h2 id="deploy-to-kubernetes-cluster">Deploy to Kubernetes cluster</h2>

<p>Setelah cluster kubernetes siap dan kita coba test network connection antar pod bisa juga, tahap selanjutnya adalah kita buat Kubernetes resourcesnya sepert Pod, dan Service yang masing-masing di kelompokan berdasarkan Namespace berdasarkan design architecture Kubernetes resources sebelumnya.</p>

<p>Secara sturuktur kita kelompokan seperti berikut:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">namespaces</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nginx</span>
  <span class="pi">-</span> <span class="na">customer</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">customer-api</span>
      <span class="pi">-</span> <span class="s">mysql</span>
  <span class="pi">-</span> <span class="na">orders</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">orders-api</span>
      <span class="pi">-</span> <span class="s">postgresql</span>
</code></pre></div></div>

<p>Seperti berikut untuk kubernetes resources dengan namespace <code class="language-plaintext highlighter-rouge">customer-module</code></p>

<script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-ns-customer-api.yaml"> </script>

<p>Kemudian kita coba jalankan dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl apply <span class="nt">-f</span> kubernetes/ns-customer-api.yaml</code></pre></figure>

<p>Maka hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl apply <span class="nt">-f</span> kubernetes/ns-customer-api.yaml
namespace/customer-module created
configmap/mysql created
secret/mysql created
pod/mysql created
service/mysql created
pod/customer-api created
service/customer-api created

~ » kubectl get pod <span class="nt">-n</span> customer-module
NAME           READY   STATUS    RESTARTS   AGE
customer-api   1/1     Running   0          13s
mysql          1/1     Running   0          6m36s

~ » kubectl logs customer-api <span class="nt">-n</span> customer-module

  <span class="nb">.</span>   ____          _            __ _ _
 /<span class="se">\\</span> / ___<span class="s1">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ | <span class="s1">'_| | '</span>_ <span class="se">\/</span> _<span class="sb">`</span> | <span class="se">\ \ \ \</span>
 <span class="se">\\</span>/  ___<span class="o">)</span>| |_<span class="o">)</span>| | | | | <span class="o">||</span> <span class="o">(</span>_| |  <span class="o">)</span> <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
  <span class="s1">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.0.2)

2023-02-25T06:49:26.684Z  INFO 1 --- [           main] c.m.d.udemy.customer.MainApplication     : Starting MainApplication v0.0.1-SNAPSHOT using Java 19 with PID 1 (/spring-boot.jar started by root in /)
2023-02-25T06:49:31.550Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 9090 (http)
2023-02-25T06:49:33.287Z  INFO 1 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2023-02-25T06:49:33.356Z  INFO 1 --- [           main] o.f.c.i.database.base.BaseDatabaseType   : Database: jdbc:mysql://mysql:3306/customer_api (MySQL 8.0)
2023-02-25T06:49:33.728Z  INFO 1 --- [           main] o.f.core.internal.command.DbValidate     : Successfully validated 1 migration (execution time 00:00.090s)
2023-02-25T06:49:33.815Z  INFO 1 --- [           main] o.f.c.i.s.JdbcTableSchemaHistory         : Creating Schema History table `customer_api`.`flyway_schema_history` ...
2023-02-25T06:49:34.140Z  INFO 1 --- [           main] o.f.core.internal.command.DbMigrate      : Current version of schema `customer_api`: &lt;&lt; Empty Schema &gt;&gt;
2023-02-25T06:49:34.184Z  INFO 1 --- [           main] o.f.core.internal.command.DbMigrate      : Migrating schema `customer_api` to version "20230211170102 - schema-customer"
2023-02-25T06:49:34.298Z  INFO 1 --- [           main] o.f.core.internal.command.DbMigrate      : Successfully applied 1 migration to schema `customer_api`, now at version v20230211170102 (execution time 00:00.190s)
2023-02-25T06:49:38.606Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 9090 (http) with context path ''
2023-02-25T06:49:38.639Z  WARN 1 --- [           main] JpaBaseConfiguration$JpaWebConfiguration : spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
2023-02-25T06:49:38.685Z  INFO 1 --- [           main] c.m.d.udemy.customer.MainApplication     : Started MainApplication in 15.321 seconds (process running for 17.433)

~ » kubectl exec mysql -n customer-module -it -- mysql -e '</span>show tables<span class="p">;</span><span class="s1">' --database customer_api -u customer_api -p
Enter password:
+------------------------+
| Tables_in_customer_api |
+------------------------+
| customer               |
| flyway_schema_history  |
+------------------------+

~ » kubectl exec customer-api -n customer-module -- curl --location --request GET '</span>localhost:9090/api/customer/v1/findById/cust01<span class="s1">' -v
Note: Unnecessary use of -X or --request, GET is already inferred.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 9090 (#0)
&gt; GET /api/customer/v1/findById/cust01 HTTP/1.1
&gt; Host: localhost:9090
&gt; User-Agent: curl/7.61.1
&gt; Accept: */*
&gt;
  0     0    0     0    0     0      0      0 --:--:--  0:00:02 --:--:--     0&lt; HTTP/1.1 200
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sat, 25 Feb 2023 07:14:25 GMT
&lt;
{ [100 bytes data]
100    94    0    94    0     0     30      0 --:--:--  
{"id":"cust01","userId":"dimasm93","fullname":"Dimas Maryanto","alamat":"Bandung, Jawa Barat"}
</span></code></pre></div></div>

<p>Selanjutnya kita deploy untuk namespace <code class="language-plaintext highlighter-rouge">orders</code> seperti berikut:</p>

<script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-ns-orders-api.yaml"> </script>

<p>Kemudian kita coba jalankan dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl apply <span class="nt">-f</span> kubernetes/ns-orders-api.yaml</code></pre></figure>

<p>Jika dijalankan maka hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl apply <span class="nt">-f</span> kubernetes/ns-orders-api.yaml
namespace/orders-module created
configmap/postgresql created
secret/postgresql created
pod/postgresql created
service/postgresql created
pod/orders-api created
service/orders-api created

~ » kubectl get pod <span class="nt">-n</span> orders-module
NAME         READY   STATUS    RESTARTS   AGE
orders-api   1/1     Running   0          15s
postgresql   1/1     Running   0          15s

~ » kubectl logs orders-api <span class="nt">-n</span> orders-module

  <span class="nb">.</span>   ____          _            __ _ _
 /<span class="se">\\</span> / ___<span class="s1">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ | <span class="s1">'_| | '</span>_ <span class="se">\/</span> _<span class="sb">`</span> | <span class="se">\ \ \ \</span>
 <span class="se">\\</span>/  ___<span class="o">)</span>| |_<span class="o">)</span>| | | | | <span class="o">||</span> <span class="o">(</span>_| |  <span class="o">)</span> <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
  <span class="s1">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.0.2)

2023-02-25T07:05:01.905Z  INFO 1 --- [           main] c.m.dimas.udemy.orders.MainApplication   : Starting MainApplication v0.0.1-SNAPSHOT using Java 19 with PID 1 (/spring-boot.jar started by root in /)
2023-02-25T07:05:06.506Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 9091 (http)
2023-02-25T07:05:07.808Z  INFO 1 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2023-02-25T07:05:07.888Z  INFO 1 --- [           main] o.f.c.i.database.base.BaseDatabaseType   : Database: jdbc:postgresql://postgresql:5432/order_api (PostgreSQL 15.1)
2023-02-25T07:05:07.985Z  INFO 1 --- [           main] o.f.core.internal.command.DbValidate     : Successfully validated 1 migration (execution time 00:00.041s)
2023-02-25T07:05:08.013Z  INFO 1 --- [           main] o.f.c.i.s.JdbcTableSchemaHistory         : Creating Schema History table "public"."flyway_schema_history" ...
2023-02-25T07:05:08.127Z  INFO 1 --- [           main] o.f.core.internal.command.DbMigrate      : Current version of schema "public": &lt;&lt; Empty Schema &gt;&gt;
2023-02-25T07:05:08.160Z  INFO 1 --- [           main] o.f.core.internal.command.DbMigrate      : Migrating schema "public" to version "20230211171555 - create-order"
2023-02-25T07:05:08.225Z  INFO 1 --- [           main] o.f.core.internal.command.DbMigrate      : Successfully applied 1 migration to schema "public", now at version v20230211171555 (execution time 00:00.121s)
2023-02-25T07:05:24.876Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 9091 (http) with context path ''
2023-02-25T07:05:25.288Z  INFO 1 --- [           main] c.m.dimas.udemy.orders.MainApplication   : Started MainApplication in 25.583 seconds (process running for 28.329)

~ » kubectl exec orders-api -n orders-module -- curl --location --request POST '</span>localhost:9091/api/order/v1/checkout<span class="s1">' \
--header '</span>Content-Type: application/json<span class="s1">' \
--data-raw '</span><span class="o">{</span>
    <span class="s2">"userId"</span>: <span class="s2">"cust01"</span>,
    <span class="s2">"item"</span>: <span class="s2">"Macbook Pro 13</span><span class="se">\"</span><span class="s2"> (A1723)"</span>,
    <span class="s2">"qty"</span>: <span class="s2">"2"</span>
<span class="o">}</span><span class="s1">' -v
Note: Unnecessary use of -X or --request, POST is already inferred.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 9091 (#0)
&gt; POST /api/order/v1/checkout HTTP/1.1
&gt;
} [82 bytes data]
* upload completely sent off: 82 out of 82 bytes
&lt; HTTP/1.1 500
&lt; Content-Type: application/json

{"timestamp":"2023-02-25T08:05:26.037+00:00","status":500,"error":"Internal Server Error","path":"/api/order/v1100   204    0   122  100    82    163    109 --:--:-- --:--:-- --:--:--   273
* Closing connection 0
</span></code></pre></div></div>

<h2 id="connecting-other-service-from-the-another-namespace">Connecting other service from the another namespace</h2>

<p>Setelah kita deploy ke kubernetes cluster, jika temen-temen perhatikan kembali output yang dihasilkan dari service <code class="language-plaintext highlighter-rouge">orders-api</code> kita melakukan request ke endpoint <code class="language-plaintext highlighter-rouge">/api/order/v1/checkout</code> hasilnya <code class="language-plaintext highlighter-rouge">HTTP/Status 500, Internal Server Error</code> klo kita lihat dari log errornya pada service tersebut seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl logs orders-api <span class="nt">-n</span> orders-module
ith path <span class="o">[]</span> threw exception <span class="o">[</span>Request processing failed: org.springframework.web.client.ResourceAccessException: I/O error on GET request <span class="k">for</span> <span class="s2">"http://localhost:9090/api/customer/v1/findById/cust01"</span>: Connection refused] with root cause

java.net.ConnectException: Connection refused
	at java.base/sun.nio.ch.Net.pollConnect<span class="o">(</span>Native Method<span class="o">)</span> ~[na:na]
	at java.base/sun.nio.ch.Net.pollConnectNow<span class="o">(</span>Net.java:672<span class="o">)</span> ~[na:na]
	at java.base/sun.nio.ch.NioSocketImpl.timedFinishConnect<span class="o">(</span>NioSocketImpl.java:535<span class="o">)</span> ~[na:na]
	at java.base/sun.nio.ch.NioSocketImpl.connect<span class="o">(</span>NioSocketImpl.java:585<span class="o">)</span> ~[na:na]
	at java.base/java.net.Socket.connect<span class="o">(</span>Socket.java:666<span class="o">)</span> ~[na:na]
	at java.base/sun.net.NetworkClient.doConnect<span class="o">(</span>NetworkClient.java:178<span class="o">)</span> ~[na:na]
</code></pre></div></div>

<p>Nah jika temen-temen perhatikan pada log tersebut, terlihat ada error gak bisa connect ke <code class="language-plaintext highlighter-rouge">localhost:9090/api/xxx/xxx</code> dari <code class="language-plaintext highlighter-rouge">orders-api</code>, Sedangkan kita mau ngambil data dari service <code class="language-plaintext highlighter-rouge">customer-api</code>. Lantas gimana caranya?</p>

<p>Kita sebelumnya udah membuat service untuk masing-masing pod seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl get service <span class="nt">-n</span> orders-module
NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
orders-api   NodePort   10.109.82.183   &lt;none&gt;        9091:31963/TCP   144m
postgresql   NodePort   10.100.81.138   &lt;none&gt;        5432:32759/TCP   144m

~ » kubectl get service <span class="nt">-n</span> customer-module
NAME           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>          AGE
customer-api   NodePort   10.99.232.190   &lt;none&gt;        9090:31920/TCP   122m
mysql          NodePort   10.96.9.233     &lt;none&gt;        3306:32554/TCP   172m
</code></pre></div></div>

<p>Nah jadi kalau dari kasus sebelumnya kita mau koneksi ke database maka kita bisa menggunakan hostname dari nama service tersebut misalnya <code class="language-plaintext highlighter-rouge">jdbc:postgresql://postgresql:5432/xxxx</code> nah serupa dengan hal tersebut dengan mengkases service <code class="language-plaintext highlighter-rouge">customer-api</code> dari <code class="language-plaintext highlighter-rouge">orders-api</code> tapi bagaimana dengan berbeda namespase.</p>

<p>Kita bisa menggunakan Kubernetes DNS queries untuk memangil service lain yang terletak pada namespace lain, seperti berikut:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/resolv.conf
</span><span class="n">search</span> &lt;<span class="n">namespace</span>&gt;.<span class="n">svc</span>.<span class="n">cluster</span>.<span class="n">local</span> &lt;<span class="n">service</span>&gt;.&lt;<span class="n">namespace</span>&gt;.<span class="n">cluster</span>.<span class="n">local</span>
</code></pre></div></div>

<p>Kita coba panggil service <code class="language-plaintext highlighter-rouge">customer-api</code> dari pod <code class="language-plaintext highlighter-rouge">order-api</code> dengan simple <code class="language-plaintext highlighter-rouge">curl</code> seperti berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl <span class="nb">exec </span>orders-api <span class="nt">-n</span> orders-module <span class="nt">--</span> curl <span class="nt">--location</span> <span class="nt">--request</span> GET <span class="s1">'http://customer-api.customer-module:9090/api/customer/v1/findById/cust01'</span> <span class="nt">-v</span></code></pre></figure>

<p>Coba klo kita jalankan outputnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl <span class="nb">exec </span>orders-api <span class="nt">-n</span> orders-module <span class="nt">--</span> curl <span class="nt">--location</span> <span class="nt">--request</span> GET <span class="s1">'http://customer-api.customer-module:9090/api/customer/v1/findById/cust01'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, GET is already inferred.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--     0<span class="k">*</span>   Trying 10.99.232.190...
<span class="k">*</span> TCP_NODELAY <span class="nb">set</span>
<span class="k">*</span> Connected to customer-api.customer-module <span class="o">(</span>10.99.232.190<span class="o">)</span> port 9090 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /api/customer/v1/findById/cust01 HTTP/1.1
<span class="o">&gt;</span> Host: customer-api.customer-module:9090
<span class="o">&gt;</span> User-Agent: curl/7.61.1
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span>
&lt; HTTP/1.1 200
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
100    94    0    94    0     0    209      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--   209
<span class="k">*</span> Connection <span class="c">#0 to host customer-api.customer-module left intact</span>
<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"cust01"</span>,<span class="s2">"userId"</span>:<span class="s2">"dimasm93"</span>,<span class="s2">"fullname"</span>:<span class="s2">"Dimas Maryanto"</span>,<span class="s2">"alamat"</span>:<span class="s2">"Bandung, Jawa Barat"</span><span class="o">}</span>
</code></pre></div></div>

<p>Nah sekarang sudah okay bisa mendapatkan response, kita coba update specifikasi podnya dengan menambahkan variable <code class="language-plaintext highlighter-rouge">SERVICE_CUSTOMER_HOST</code>, <code class="language-plaintext highlighter-rouge">SERVICE_CUSTOMER_PORT</code>, <code class="language-plaintext highlighter-rouge">SERVICE_CUSTOMER_PROTO</code> dengan membuat configmap dan tambahkan ke spec pod <code class="language-plaintext highlighter-rouge">orders-api</code> seperti berikut:</p>

<script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-cm-orders-api-integrasi.yaml"> </script>

<p>Sekarang kita coba jalankan dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl delete pod/orders-api <span class="nt">-n</span> orders-module
kubectl apply <span class="nt">-f</span> kubernetes/ns-orders-api.yaml</code></pre></figure>

<p>Jika dijalankan outputnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl delete pod/orders-api <span class="nt">-n</span> orders-module
pod <span class="s2">"orders-api"</span> deleted

~ » kubectl apply <span class="nt">-f</span> kubernetes/ns-orders-api.yaml
configmap/orders-api created
pod/orders-api created

~ » kubectl get pod <span class="nt">-n</span> orders-module
NAME         READY   STATUS    RESTARTS   AGE
orders-api   1/1     Running   0          40s
postgresql   1/1     Running   0          166m

~ » kubectl logs orders-api <span class="nt">-n</span> orders-module

  <span class="nb">.</span>   ____          _            __ _ _
 /<span class="se">\\</span> / ___<span class="s1">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ | <span class="s1">'_| | '</span>_ <span class="se">\/</span> _<span class="sb">`</span> | <span class="se">\ \ \ \</span>
 <span class="se">\\</span>/  ___<span class="o">)</span>| |_<span class="o">)</span>| | | | | <span class="o">||</span> <span class="o">(</span>_| |  <span class="o">)</span> <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
  <span class="s1">'  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.0.2)

2023-02-25T09:51:19.825Z  INFO 1 --- [           main] c.m.dimas.udemy.orders.MainApplication   : Started MainApplication in 42.845 seconds (process running for 46.726)

~ » kubectl exec orders-api -n orders-module -- curl --location --request POST '</span>localhost:9091/api/order/v1/checkout<span class="s1">' \
--header '</span>Content-Type: application/json<span class="s1">' \
--data-raw '</span><span class="o">{</span>
    <span class="s2">"userId"</span>: <span class="s2">"cust01"</span>,
    <span class="s2">"item"</span>: <span class="s2">"Macbook Pro 13</span><span class="se">\"</span><span class="s2"> (A1723)"</span>,
    <span class="s2">"qty"</span>: <span class="s2">"2"</span>
<span class="o">}</span><span class="s1">' -v

* TCP_NODELAY set
* Connected to localhost (::1) port 9091 (#0)
&gt; POST /api/order/v1/checkout HTTP/1.1
&gt; Host: localhost:9091
&gt; User-Agent: curl/7.61.1
&gt; Accept: */*
&gt; Content-Type: application/json
&gt; Content-Length: 82
&gt;
} [82 bytes data]
* upload completely sent off: 82 out of 82 bytes
100    82    0     0  100    82      0     19  0:00:04  0:00:04 --:--:--    19

{"id":"bb9f7d1e-92ef-4307-b412-ce112fbc01f6","createdDate":"2023-02-25T09:52:58.443768159","customer":{"id":"cust01","userId":"dimasm93","fullname":"Dimas Maryanto","alamat":"Bandung, Jawa Barat"},"item":"Macbook Pro 13\" (A1723)","qty":2}

&lt; HTTP/1.1 200
</span></code></pre></div></div>

<p>Okay sampai sini kita sudah berhasil membuat microservice berjalan dengan baik di kubernetes, selanjutnya adalah kita buat feature kubernetes lebih advance lagi.</p>

<h2 id="specify-container-probes">Specify container probes</h2>

<p>Okay, sebelumnya kita khan sudah deploy container springboot untuk service <code class="language-plaintext highlighter-rouge">customer-api</code> dan <code class="language-plaintext highlighter-rouge">orders-api</code> ke Kubernetes cluster, hanya masih belum optimal contohnya startup service masih lama, kemudian jika database connection mati belum ada feature auto recover. Nah jadi untuk menambahkan feature tersebut ada yang perlu kita tambahkan pada framework springboot tersebut yaitu menggunakan lib <code class="language-plaintext highlighter-rouge">spring-boot-starter-actuator</code> yang kita tambahkan ke file <code class="language-plaintext highlighter-rouge">pom.xml</code> seperti berikut:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>

<span class="c">&lt;!-- project settings --&gt;</span>

<span class="nt">&lt;dependencies&gt;</span>
  <span class="c">&lt;!-- other dependency --&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span></code></pre></figure>

<p>Dan edit/tambahkan property <code class="language-plaintext highlighter-rouge">management.health</code> pada file <code class="language-plaintext highlighter-rouge">src/main/resources/application.yaml</code> seperti berikut:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1">## other properties</span>
<span class="na">management</span><span class="pi">:</span>
  <span class="na">endpoint</span><span class="pi">:</span>
    <span class="na">health</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">probes</span><span class="pi">:</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="kc">true</span>
      <span class="na">group</span><span class="pi">:</span>
        <span class="na">liveness</span><span class="pi">:</span>
          <span class="na">include</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">db</span>
      <span class="na">show-components</span><span class="pi">:</span> <span class="s">always</span>
<span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">org.springframework</span><span class="pi">:</span> <span class="s">fatal</span>
    <span class="na">org.flywaydb.core.internal.license</span><span class="pi">:</span> <span class="s">fatal</span>
    <span class="na">org.hibernate</span><span class="pi">:</span> <span class="s">fatal</span></code></pre></figure>

<p>Jika sudah coba jalankan dengan menggunakan perintah berikut</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mvn clean <span class="nt">-pl</span> customer spring-boot:run</code></pre></figure>

<p>Jika sudah coba akses endpoint <a href="http://localhost:9090/actuator/health">localhost:9090/actuator/health</a> hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » curl localhost:9090/actuator/health
<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"UP"</span>,<span class="s2">"components"</span>:<span class="o">{</span><span class="s2">"db"</span>:<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"UP"</span><span class="o">}</span>,<span class="s2">"diskSpace"</span>:<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"UP"</span><span class="o">}</span>,<span class="s2">"livenessState"</span>:<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"UP"</span><span class="o">}</span>,<span class="s2">"ping"</span>:<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"UP"</span><span class="o">}</span>,<span class="s2">"readinessState"</span>:<span class="o">{</span><span class="s2">"status"</span>:<span class="s2">"UP"</span><span class="o">}}</span>,<span class="s2">"groups"</span>:[<span class="s2">"liveness"</span>,<span class="s2">"readiness"</span><span class="o">]}</span>%
</code></pre></div></div>

<p>Jika sudah seperti itu outputnya, lakukan hal yang sama dengan service <code class="language-plaintext highlighter-rouge">orders-api</code> dan kemudian coba re-build container image kemudian push menggunakan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">docker compose build <span class="o">&amp;&amp;</span> <span class="se">\</span>
docker compose push</code></pre></figure>

<p>Setelah kita push container image dari kedua service tersebut, sekarang kita bisa tambahkan feature container probe di kubernetes resource object pod seperti berikut:</p>

<script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-pod-container-probe.yaml"> </script>

<p>Sekarang coba jalankan dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl delete pod customer-api <span class="nt">-n</span> customer-module <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl delete pod orders-api <span class="nt">-n</span> orders-module

kubectl apply <span class="nt">-f</span> kubernetes/pod-container-probes.yaml</code></pre></figure>

<p>Maka hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl delete <span class="nt">-f</span> kubernetes/pod-container-probes.yaml
pod <span class="s2">"orders-api"</span> deleted
pod <span class="s2">"customer-api"</span> deleted

~ » kubectl apply <span class="nt">-f</span> kubernetes/pod-container-probes.yaml
pod/orders-api created
pod/customer-api created

~ » kubectl get pod <span class="nt">-A</span>
NAMESPACE         NAME             READY   STATUS              RESTARTS   AGE
customer-module   customer-api     0/1     ContainerCreating   0          6s
customer-module   mysql            1/1     Running             0          9m29s
orders-module     orders-api       0/1     Running             0          6s
orders-module     postgresql       1/1     Running             0          9m12s

~ » kubectl describe pod customer-api <span class="nt">-n</span> customer-module
Name:             customer-api
Namespace:        customer-module
Priority:         0
Service Account:  default
Node:             springboot-microservice-m03/192.168.64.25
Start Time:       Sat, 25 Feb 2023 23:53:15 +0700
Labels:           <span class="nv">app</span><span class="o">=</span>customer-api
                  <span class="nv">project</span><span class="o">=</span>customer
                  <span class="nv">tier</span><span class="o">=</span>backend
Status:           Running
IP:               10.244.2.9
IPs:
  IP:  10.244.2.9

Events:
  Type    Reason     Age   From               Message
  <span class="nt">----</span>    <span class="nt">------</span>     <span class="nt">----</span>  <span class="nt">----</span>               <span class="nt">-------</span>
  Normal  Scheduled  20s   default-scheduler  Successfully assigned customer-module/customer-api to springboot-microservice-m03
  Normal  Pulled     18s   kubelet            Container image <span class="s2">"192.168.88.50:8086/dimmaryanto93/example/customer-api:v2"</span> already present on machine
  Normal  Created    17s   kubelet            Created container customer-api
  Normal  Started    17s   kubelet            Started container customer-api

~ » kubectl get pod <span class="nt">-n</span> customer-module
NAME           READY   STATUS    RESTARTS   AGE
customer-api   1/1     Running   0          57s
mysql          1/1     Running   0          19m

~ » kubectl get pod <span class="nt">-n</span> orders-module
NAME         READY   STATUS    RESTARTS   AGE
orders-api   0/1     Running   0          14s
postgresql   1/1     Running   0          20m

~ » kubectl describe pod orders-api <span class="nt">-n</span> orders-module
Name:             orders-api
Namespace:        orders-module
Priority:         0
Service Account:  default
Node:             springboot-microservice-m03/192.168.64.25
Start Time:       Sun, 26 Feb 2023 00:03:58 +0700
Labels:           <span class="nv">app</span><span class="o">=</span>orders-api
                  <span class="nv">project</span><span class="o">=</span>orders-api
                  <span class="nv">tier</span><span class="o">=</span>backend
Annotations:      &lt;none&gt;
Status:           Running
IP:               10.244.2.14
IPs:
  IP:  10.244.2.14

Events:
  Type    Reason     Age   From               Message
  <span class="nt">----</span>    <span class="nt">------</span>     <span class="nt">----</span>  <span class="nt">----</span>               <span class="nt">-------</span>
  Normal  Scheduled  26s   default-scheduler  Successfully assigned orders-module/orders-api to springboot-microservice-m03
  Normal  Pulled     25s   kubelet            Container image <span class="s2">"192.168.88.50:8086/dimmaryanto93/example/order-api:v2"</span> already present on machine
  Normal  Created    25s   kubelet            Created container orders-api
  Normal  Started    25s   kubelet            Started container orders-api

~ » kubectl get pod <span class="nt">-n</span> orders-module
NAME         READY   STATUS    RESTARTS   AGE
orders-api   1/1     Running   0          70s
postgresql   1/1     Running   0          20m
</code></pre></div></div>

<h2 id="specify-resource-request-and-limit">Specify resource request and limit</h2>

<p>Tahap selanjutnya untuk mengoptimalkan penggunaan resource node/worker kita harus specifikasi resource request dan limit. Resource request dan limit ini sangat membantu untuk menambahkan alert pada system kubernetes agar pod tidak menggunakan resource yang berlebih atau masih bisa mencukupi resource yang ada (resource availablity).</p>

<p>Untuk menentukan resource request dan limit ini kita harus mengetahui dulu titik minimum dari workload aplikasi kita dan titik optimal (rata-rata operational) dengan cara melihat activity process, metrics untuk penggunaan cpus dan memory. Sebagai contoh disini saya menggunakan Activity Monitor untuk melihat penggunaan system memory dan cpus.</p>

<p>Berikut adalah cpu yang terpakai dari workload <code class="language-plaintext highlighter-rouge">customer-api</code>:</p>

<p><img src="/resources/posts/kubernetes/04b-study-cases-microservice-apps/04-cpus-usage.png" alt="cpu-usage" /></p>

<p>Berikut adalah memory yang terpakai:</p>

<p><img src="/resources/posts/kubernetes/04b-study-cases-microservice-apps/04-memory-usage.png" alt="memory-usage" /></p>

<p>Atau selain itu juga kita bisa expose dari service tersebut dengan menambahkan beberapa property <code class="language-plaintext highlighter-rouge">metrics</code> pada <code class="language-plaintext highlighter-rouge">src/main/resources/application.yaml</code> seperti berikut:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1">## other properties</span>
<span class="na">management</span><span class="pi">:</span>
  <span class="na">endpoints</span><span class="pi">:</span>
    <span class="na">web</span><span class="pi">:</span>
      <span class="na">exposure</span><span class="pi">:</span>
        <span class="na">include</span><span class="pi">:</span> <span class="s">health,metrics</span></code></pre></figure>

<p>Kemudian coba jalankan dengan perintah:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mvn clean <span class="nt">-pl</span> customer spring-boot:run</code></pre></figure>

<p>Jika dijalankan hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » curl localhost:9090/actuator/metrics
<span class="o">{</span>
  <span class="s2">"names"</span>: <span class="o">[</span>
    <span class="s2">"application.ready.time"</span>,
    <span class="s2">"application.started.time"</span>,
    <span class="s2">"disk.free"</span>,
    <span class="s2">"disk.total"</span>,
    <span class="s2">"hikaricp.connections"</span>,
    <span class="s2">"hikaricp.connections.acquire"</span>,
    <span class="s2">"hikaricp.connections.active"</span>,
    <span class="s2">"hikaricp.connections.creation"</span>,
    <span class="s2">"hikaricp.connections.idle"</span>,
    <span class="s2">"hikaricp.connections.max"</span>,
    <span class="s2">"hikaricp.connections.min"</span>,
    <span class="s2">"hikaricp.connections.pending"</span>,
    <span class="s2">"hikaricp.connections.timeout"</span>,
    <span class="s2">"hikaricp.connections.usage"</span>,
    <span class="s2">"http.server.requests.active"</span>,
    <span class="s2">"jdbc.connections.active"</span>,
    <span class="s2">"jdbc.connections.idle"</span>,
    <span class="s2">"jdbc.connections.max"</span>,
    <span class="s2">"jdbc.connections.min"</span>,
    <span class="s2">"jvm.buffer.count"</span>,
    <span class="s2">"jvm.buffer.memory.used"</span>,
    <span class="s2">"jvm.buffer.total.capacity"</span>,
    <span class="s2">"jvm.classes.loaded"</span>,
    <span class="s2">"jvm.classes.unloaded"</span>,
    <span class="s2">"jvm.compilation.time"</span>,
    <span class="s2">"jvm.gc.live.data.size"</span>,
    <span class="s2">"jvm.gc.max.data.size"</span>,
    <span class="s2">"jvm.gc.memory.allocated"</span>,
    <span class="s2">"jvm.gc.memory.promoted"</span>,
    <span class="s2">"jvm.gc.overhead"</span>,
    <span class="s2">"jvm.info"</span>,
    <span class="s2">"jvm.memory.committed"</span>,
    <span class="s2">"jvm.memory.max"</span>,
    <span class="s2">"jvm.memory.usage.after.gc"</span>,
    <span class="s2">"jvm.memory.used"</span>,
    <span class="s2">"jvm.threads.daemon"</span>,
    <span class="s2">"jvm.threads.live"</span>,
    <span class="s2">"jvm.threads.peak"</span>,
    <span class="s2">"jvm.threads.states"</span>,
    <span class="s2">"logback.events"</span>,
    <span class="s2">"process.cpu.usage"</span>,
    <span class="s2">"process.files.max"</span>,
    <span class="s2">"process.files.open"</span>,
    <span class="s2">"process.start.time"</span>,
    <span class="s2">"process.uptime"</span>,
    <span class="s2">"system.cpu.count"</span>,
    <span class="s2">"system.cpu.usage"</span>,
    <span class="s2">"system.load.average.1m"</span>,
    <span class="s2">"tomcat.sessions.active.current"</span>,
    <span class="s2">"tomcat.sessions.active.max"</span>,
    <span class="s2">"tomcat.sessions.alive.max"</span>,
    <span class="s2">"tomcat.sessions.created"</span>,
    <span class="s2">"tomcat.sessions.expired"</span>,
    <span class="s2">"tomcat.sessions.rejected"</span>
  <span class="o">]</span>
<span class="o">}</span>%

~ » curl localhost:9090/actuator/metrics/jvm.info
<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"jvm.info"</span>,
  <span class="s2">"description"</span>: <span class="s2">"JVM version info"</span>,
  <span class="s2">"measurements"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"statistic"</span>: <span class="s2">"VALUE"</span>,
      <span class="s2">"value"</span>: 1
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"availableTags"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"tag"</span>: <span class="s2">"vendor"</span>,
      <span class="s2">"values"</span>: <span class="o">[</span>
        <span class="s2">"Oracle Corporation"</span>
      <span class="o">]</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"tag"</span>: <span class="s2">"runtime"</span>,
      <span class="s2">"values"</span>: <span class="o">[</span>
        <span class="s2">"Java(TM) SE Runtime Environment"</span>
      <span class="o">]</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"tag"</span>: <span class="s2">"version"</span>,
      <span class="s2">"values"</span>: <span class="o">[</span>
        <span class="s2">"19.0.1+10-21"</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Temen-temen bisa check menggunakan beberapa property seperti <code class="language-plaintext highlighter-rouge">jvm.memory.used</code>, <code class="language-plaintext highlighter-rouge">system.cpu.usage</code>, <code class="language-plaintext highlighter-rouge">process.cpu.usage</code> dan lain-lain. Okay selanjutnya kita build ulang container imagenya supaya metrics tersebut terexpose dengan perintah</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mvn clean <span class="nt">-DskipTests</span> package

docker compose build customerAPI <span class="o">&amp;&amp;</span> <span class="se">\</span>
docker compose push customerAPI</code></pre></figure>

<p>Okay jadi disini saya simpulkan bahwa batas minimum atau resource request yaitu <code class="language-plaintext highlighter-rouge">cpu = 100m</code> dan <code class="language-plaintext highlighter-rouge">memory = 250Mi</code> sedangkan untuk maximum limit yaitu <code class="language-plaintext highlighter-rouge">cpu = 1500m</code> dan <code class="language-plaintext highlighter-rouge">memory = 2000Mi</code>. Sekarang kita coba update file pod.yaml menjadi seperti berikut:</p>

<script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-pod-resource-request-limit.yaml"> </script>

<p>Sekarang kita coba jalankan file tersebut dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl delete pod customer-api <span class="nt">-n</span> customer-module <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl delete pod orders-api <span class="nt">-n</span> orders-module

kubectl apply <span class="nt">-f</span> kubernetes/pod-resource-request-limit.yaml</code></pre></figure>

<p>Maka hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl delete pod customer-api <span class="nt">-n</span> customer-module <span class="o">&amp;&amp;</span> <span class="se">\</span>
kubectl delete pod orders-api <span class="nt">-n</span> orders-module
pod <span class="s2">"customer-api"</span> deleted
pod <span class="s2">"orders-api"</span> deleted

~ » kubectl top node
NAME                          CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%
springboot-microservice       497m         24%    1360Mi          34%
springboot-microservice-m02   266m         13%    1571Mi          40%
springboot-microservice-m03   491m         24%    919Mi           23%

~ » kubectl apply <span class="nt">-f</span> kubernetes/pod-resource-request-limit.yaml
pod/customer-api created
pod/orders-api created

~ » kubectl get pod <span class="nt">-n</span> customer-module
NAME           READY   STATUS    RESTARTS   AGE
customer-api   1/1     Running   0          55s
mysql          1/1     Running   0          6m53s

~ » kubectl top pod customer-api <span class="nt">-n</span> customer-module
NAME           CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>
customer-api   536m         260Mi

~ » kubectl get pod <span class="nt">-n</span> orders-module
NAME         READY   STATUS    RESTARTS   AGE
orders-api   1/1     Running   0          91s
postgresql   1/1     Running   0          7m6s

~ » kubectl top pod orders-api <span class="nt">-n</span> orders-module
NAME         CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>
orders-api   9m           273Mi

~ » kubectl top node
NAME                          CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%
springboot-microservice       151m         7%     1349Mi          34%
springboot-microservice-m02   62m          3%     1861Mi          47%
springboot-microservice-m03   45m          2%     1184Mi          30%
</code></pre></div></div>

<h2 id="implement-api-gateway-using-nginx-reverse-proxy">Implement API Gateway using nginx reverse proxy</h2>

<p>Okay sebelumnya kita sudah deploy workload ke kubernetes cluster, kemudian juga sudah lakukan tuning workloadnya supaya bisa berjalan dengan baik di kubernetes dengan menambahkan container probe dan resource request &amp; limit. Ini adalah ujung dari studikasus ini yaitu kita akan memasang API Gateway. okay temen-temen ada yang tau apa itu API Gateway? mengapa harus menggunakan API Gateway?</p>

<p>An API gateway is an API management tool that sits between a client and a collection of backend services. An API gateway acts as a reverse proxy to accept all application programming interface (API) calls, aggregate the various services required to fulfill them, and return the appropriate result.</p>

<p>Nah karena kita punya banyak services (microservices) jadi pada implementasinya exposing service tersebut tidak satu-per-satu atau setiap service memiliki port sendiri tetapi biasanya menggunakan methode DMZ (Demilitarized Zone) atau satu gerbang untuk beberapa service jika kita ilustrasikan seperti berikut:</p>

<p><img src="/resources/posts/kubernetes/04b-study-cases-microservice-apps/05-dmz-system.png" alt="dmz-services" /></p>

<p>Untuk implementasi API Gateway ini ada lumayan banyak salah satunya adalah <a href="https://apisix.apache.org/">apisix</a>, <a href="https://www.nginx.com/">nginx</a>, <a href="https://www.krakend.io/">KrakenD</a> dan lain-lain. Untuk kasus kali ini kita akan menggunakan yang simple dulu ya yaitu Nginx reverse proxy dengan configurasi seperti berikut:</p>

<script src="https://gist.github.com/dimMaryanto93/c8e8b75d52f1266a6bd7c8f5939c91f4.js?file=04b-api-gateway.yaml"> </script>

<p>Sekarang coba jalankan dengan perintah berikut:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">kubectl apply <span class="nt">-f</span> kubernetes/api-gateway.yaml</code></pre></figure>

<p>Maka hasilnya seperti berikut:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ » kubectl apply <span class="nt">-f</span> kubernetes/api-gateway 
configmap/api-gateway unchanged
pod/api-gateway created
service/api-gateway configured

~ » kubectl get pod,service
NAME              READY   STATUS    RESTARTS   AGE
pod/api-gateway   1/1     Running   0          54s

NAME                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
service/api-gateway   NodePort    10.107.243.20    &lt;none&gt;        80:30001/TCP   167m
service/kubernetes    ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP        27h

~ » kubectl cluster-info
Kubernetes control plane is running at https://192.168.64.23:8443
CoreDNS is running at https://192.168.64.23:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="s1">'kubectl cluster-info dump'</span><span class="nb">.</span>

~ » curl http://192.168.64.23:30001/customers/api/customer/v1/findById/cust01 <span class="nt">-v</span>
<span class="k">*</span>   Trying 192.168.64.23:30001...
<span class="k">*</span> Connected to 192.168.64.23 <span class="o">(</span>192.168.64.23<span class="o">)</span> port 30001 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> GET /customer/api/customer/v1/findById/cust01 HTTP/1.1
<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"cust01"</span>,<span class="s2">"userId"</span>:<span class="s2">"dimasm93"</span>,<span class="s2">"fullname"</span>:<span class="s2">"Dimas Maryanto"</span>,<span class="s2">"alamat"</span>:<span class="s2">"Bandung, Jawa Barat"</span><span class="o">}</span>

~ » curl <span class="nt">--location</span> <span class="nt">--request</span> POST <span class="s1">'http://192.168.64.23:30001/orders/api/order/v1/checkout'</span> <span class="se">\</span>
<span class="nt">--header</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
<span class="nt">--data-raw</span> <span class="s1">'{
    "userId": "cust01",
    "item": "Macbook Pro 13\" (A1723)",
    "qty": "2"
}'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 192.168.64.23:30001...
<span class="k">*</span> Connected to 192.168.64.23 <span class="o">(</span>192.168.64.23<span class="o">)</span> port 30001 <span class="o">(</span><span class="c">#0)</span>
<span class="o">&gt;</span> POST /order/api/order/v1/checkout HTTP/1.1
<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"2c25434d-00ec-46e6-b37f-c080291019b2"</span>,<span class="s2">"createdDate"</span>:<span class="s2">"2023-02-26T09:15:03.570489716"</span>,<span class="s2">"customer"</span>:<span class="o">{</span><span class="s2">"id"</span>:<span class="s2">"cust01"</span>,<span class="s2">"userId"</span>:<span class="s2">"dimasm93"</span>,<span class="s2">"fullname"</span>:<span class="s2">"Dimas Maryanto"</span>,<span class="s2">"alamat"</span>:<span class="s2">"Bandung, Jawa Barat"</span><span class="o">}</span>,<span class="s2">"item"</span>:<span class="s2">"Macbook Pro 13</span><span class="se">\"</span><span class="s2"> (A1723)"</span>,<span class="s2">"qty"</span>:2<span class="o">}</span>%
</code></pre></div></div>

<p>Nah jadi disini kesimpulannya yang kita expose adalah ip <code class="language-plaintext highlighter-rouge">192.168.64.23</code> dengan port <code class="language-plaintext highlighter-rouge">30001</code> saja ke router/loadbalancer yang selanjutnya kita bisa lakukan untuk port forwarding ke ip public.</p>

        
        <div class="text-right">
          <!--  -->












<nav>
  <ul class="pagination text-right">
    <!-- goto first page -->
    <li id="first_post" class="page-item">
      
      <a href="/posts/devops/orchestration/kubernetes/01-silabus"  class="" title="Silabus - DevOps Kubernetes: Pemula sampai Mahir">
        First page
      </a>
      
    </li>
    <li id="previous_page" class="page-item">
      
      <a href="/posts/devops/orchestration/kubernetes/workloads/05a-what-is-workload" class="" 
        title="What is Workload Resources?
">
        <i class="fas fa-chevron-left"></i>
      </a>
       
    </li>
    <li class="page-item">
      <a href="#" class=" disabled">
        Page 35 to 36
      </a>
    </li>
    <li id="next_page" class="page-item">
      
      <a href="/posts/devops/orchestration/kubernetes/workloads/05b-deployment" class="" 
        title="Working with Deployment object
">
        <i class="fas fa-chevron-right"></i>
      </a>
      
    </li>
    <li id="last_post" class="page-item">
      
      <a href="/posts/devops/orchestration/kubernetes/workloads/05b-deployment"  class="" title="Working with Deployment object">
        Last page
      </a>
      
    </li>
  </ul>
</nav>

<a href="#page-title" class="back-to-top">Back to top &uarr;</a>
        </div>
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#devops" class="page__taxonomy-item p-category" rel="tag">DevOps</a><span class="sep">, </span>
    
      <a href="/categories/#kubernetes" class="page__taxonomy-item p-category" rel="tag">Kubernetes</a><span class="sep">, </span>
    
      <a href="/categories/#orchestration" class="page__taxonomy-item p-category" rel="tag">Orchestration</a><span class="sep">, </span>
    
      <a href="/categories/#pods" class="page__taxonomy-item p-category" rel="tag">Pods</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2023-02-26T16:19:54+07:00">February 26, 2023</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Study+cases%3A+Microservice+apps+%28Springboot+Rest+API%29%20%2Fposts%2Fdevops%2Forchestration%2Fkubernetes%2Fpods%2F04b-study-cases-microservice-backend-apps" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fposts%2Fdevops%2Forchestration%2Fkubernetes%2Fpods%2F04b-study-cases-microservice-backend-apps" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2Fposts%2Fdevops%2Forchestration%2Fkubernetes%2Fpods%2F04b-study-cases-microservice-backend-apps" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/500x300.png" alt="">
      </div>
    
    <h3 class="archive__item-title no_toc" itemprop="headline">
      
        <a class="btn btn-sm btn-light text-nowrap" href="/posts/git/gitlab/gitlab-ci/03d-getting-started" rel="permalink">Getting started: Create and run your first Gitlab CI/CD pipeline
</a>
      
    </h3>
    
<p class="page__meta">

  
  
    <a href="/pages/cources/gitlab" target="_blank" rel="noopener noreferrer">
      <i class="fas fa-link"></i>
      GitOps with Gitlab
    </a>
    <span class="page__meta-sep"></span>
  



  
    
    <span class="page__meta-date">
      <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2023-06-18T15:30:55+07:00">June 18, 2023</time>
    </span>
  

  <span class="page__meta-sep"></span>

  
    
    

    <span class="page__meta-readtime">
      <i class="far fa-fw fa-clock" aria-hidden="true"></i>
      
        8 minute read
      
    </span>
  
    

</p>

        
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/500x300.png" alt="">
      </div>
    
    <h3 class="archive__item-title no_toc" itemprop="headline">
      
        <a class="btn btn-sm btn-light text-nowrap" href="/posts/git/gitlab/gitlab-ci/03c-setup-gitlab-ci" rel="permalink">Settings up Gitlab CI (on-premise)
</a>
      
    </h3>
    
<p class="page__meta">

  
  
    <a href="/pages/cources/gitlab" target="_blank" rel="noopener noreferrer">
      <i class="fas fa-link"></i>
      GitOps with Gitlab
    </a>
    <span class="page__meta-sep"></span>
  



  
    
    <span class="page__meta-date">
      <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2023-06-17T21:12:16+07:00">June 17, 2023</time>
    </span>
  

  <span class="page__meta-sep"></span>

  
    
    

    <span class="page__meta-readtime">
      <i class="far fa-fw fa-clock" aria-hidden="true"></i>
      
        8 minute read
      
    </span>
  
    

</p>

        
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/500x300.png" alt="">
      </div>
    
    <h3 class="archive__item-title no_toc" itemprop="headline">
      
        <a class="btn btn-sm btn-light text-nowrap" href="/posts/git/gitlab/gitlab-ci/03b-introduction-gitlab-ci" rel="permalink">Introduction of Gitlab DevSecOps Platform
</a>
      
    </h3>
    
<p class="page__meta">

  
  
    <a href="/pages/cources/gitlab" target="_blank" rel="noopener noreferrer">
      <i class="fas fa-link"></i>
      GitOps with Gitlab
    </a>
    <span class="page__meta-sep"></span>
  



  
    
    <span class="page__meta-date">
      <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2023-06-17T20:36:43+07:00">June 17, 2023</time>
    </span>
  

  <span class="page__meta-sep"></span>

  
    
    

    <span class="page__meta-readtime">
      <i class="far fa-fw fa-clock" aria-hidden="true"></i>
      
        2 minute read
      
    </span>
  
    

</p>

        
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/500x300.png" alt="">
      </div>
    
    <h3 class="archive__item-title no_toc" itemprop="headline">
      
        <a class="btn btn-sm btn-light text-nowrap" href="/posts/git/gitlab/gitlab-ci/03a-what-is-cicd" rel="permalink">What is Continues Integration/Continues Delivery (CI/CD)?
</a>
      
    </h3>
    
<p class="page__meta">

  
  
    <a href="/pages/cources/gitlab" target="_blank" rel="noopener noreferrer">
      <i class="fas fa-link"></i>
      GitOps with Gitlab
    </a>
    <span class="page__meta-sep"></span>
  



  
    
    <span class="page__meta-date">
      <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
      
      <time datetime="2023-06-17T16:52:30+07:00">June 17, 2023</time>
    </span>
  

  <span class="page__meta-sep"></span>

  
    
    

    <span class="page__meta-readtime">
      <i class="far fa-fw fa-clock" aria-hidden="true"></i>
      
        6 minute read
      
    </span>
  
    

</p>

        
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

<script>
function showCourceContent(data){
  if(data) {
    $('body').removeClass('wide');
    $('#cource_contents').show();
  } else {
    $('body').addClass('wide');
    $('#cource_contents').hide();
  }
}

</script>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://facebook.com/dimmaryanto93/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
        
      
        
          <li><a href="https://github.com/dimmaryanto93" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://instagram.com/dimmaryanto93" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
        
          <li><a href="https://www.youtube.com/@DimasMaryanto" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> Youtube</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Dimas maryanto. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
